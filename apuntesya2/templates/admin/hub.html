{% extends "base.html" %}
{% block content %}
<div style="margin:12px 0 18px;display:flex;gap:10px;flex-wrap:wrap;">
  <a href="/admin/moderation" style="padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#111827;color:#fff;text-decoration:none;font-weight:700;">üõ°Ô∏è Moderador</a>
  <a href="/admin/users" style="padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#111827;text-decoration:none;font-weight:700;">Usuarios</a>
</div>

<style>
    .admin-shell {
        max-width: 980px;
        margin: 32px auto;
    }

    .admin-card {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e5e7f5;
        padding: 22px 20px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }

    .admin-header {
        margin-bottom: 12px;
    }

    .admin-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }

    .admin-header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: #6b7280;
    }

    /* Tabs */
    .tabs {
        display: inline-flex;
        gap: 6px;
        margin: 12px 0 14px;
        padding: 4px;
        border-radius: 999px;
        background: #f7f9ff;
        border: 1px solid #e0e4ff;
        flex-wrap: wrap;
    }

    .tab {
        padding: 6px 14px;
        border-radius: 999px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        color: #4b5563;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .tab.active {
        background: #4478ff;
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(68, 120, 255, 0.35);
    }

    /* Search */
    .input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d9d9e3;
        border-radius: 999px;
        background: #ffffff;
        font-size: 14px;
    }

    .input::placeholder {
        color: #9ca3af;
    }

    .muted {
        color: #6b7280;
        font-size: 13px;
    }

    /* Cards de filas */
    .row-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid #e5e7f5;
        background: #fafbff;
        margin-top: 10px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
    }

    .row-main {
        min-width: 0;
    }

    .row-main strong {
        font-size: 14px;
        color: #111827;
    }

    .row-main .muted {
        margin-top: 2px;
        display: block;
    }

    .right {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    /* Botones */
    .btn {
        padding: 7px 12px;
        border: 0;
        border-radius: 999px;
        background: #4478ff;
        color: #fff;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none;
        transition: 0.15s;
        white-space: nowrap;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(68, 120, 255, 0.35);
    }

    .btn.ghost {
        background: #f3f6ff;
        color: #334;
        border: 1px solid #dfe4ff;
        box-shadow: none;
    }

    .btn.ghost:hover {
        background: #e4e9ff;
    }

    @media (max-width: 720px) {
        .admin-card {
            padding: 20px 16px;
        }

        .row-card {
            flex-direction: column;
            align-items: flex-start;
        }

        .right {
            width: 100%;
            justify-content: flex-start;
        }
    }
</style>

<div class="admin-shell">
    <div class="admin-card">
        <div class="admin-header">
            <h2>Administrar ApuntesYa</h2>
            <p>Busc√° y gestion√° usuarios, apuntes y archivos desde un solo lugar.</p>
        </div>

        <div class="tabs">
            <button id="tabUsers" class="tab active">
                üë• <span>Usuarios</span>
            </button>
            <button id="tabNotes" class="tab">
                üìö <span>Apuntes</span>
            </button>
            <button id="tabFiles" class="tab">
                üìÑ <span>Archivos</span>
            </button>
        </div>

        <!-- BUSCADOR -->
        <input id="searchBox" class="input" placeholder="Buscar usuario (nombre/email)">

        <!-- CONTENEDORES -->
        <div id="usersPane" style="margin-top:14px;"></div>
        <div id="notesPane" style="display:none;margin-top:14px;"></div>
        <div id="filesPane" style="display:none;margin-top:14px;"></div>
    </div>
</div>

<script>
    (function () {
        const tabUsers = document.getElementById('tabUsers');
        const tabNotes = document.getElementById('tabNotes');
        const tabFiles = document.getElementById('tabFiles');
        const searchBox = document.getElementById('searchBox');
        const usersPane = document.getElementById('usersPane');
        const notesPane = document.getElementById('notesPane');
        const filesPane = document.getElementById('filesPane');

        let activeTab = 'users'; // 'users' | 'notes' | 'files'
        let timer = null;

        function sw(tab) {
            activeTab = tab;
            tabUsers.classList.toggle('active', tab === 'users');
            tabNotes.classList.toggle('active', tab === 'notes');
            tabFiles.classList.toggle('active', tab === 'files');

            usersPane.style.display = tab === 'users' ? '' : 'none';
            notesPane.style.display = tab === 'notes' ? '' : 'none';
            filesPane.style.display = tab === 'files' ? '' : 'none';

            searchBox.placeholder =
                tab === 'users'
                    ? 'Buscar usuario (nombre/email)'
                    : tab === 'notes'
                        ? 'Buscar por t√≠tulo, descripci√≥n, universidad, facultad o carrera'
                        : 'Buscar archivos por t√≠tulo, universidad, facultad o carrera';

            load();
        }

        tabUsers.addEventListener('click', () => sw('users'));
        tabNotes.addEventListener('click', () => sw('notes'));
        tabFiles.addEventListener('click', () => sw('files'));

        searchBox.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(load, 300);
        });

        async function load() {
            const q = encodeURIComponent(searchBox.value || '');
            if (activeTab === 'users') {
                usersPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/users?q=${q}`);
                const js = await r.json();
                renderUsers(js.items || []);
            } else if (activeTab === 'notes') {
                notesPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/notes?q=${q}`);
                const js = await r.json();
                renderNotes(js.items || []);
            } else {
                filesPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/files?q=${q}`);
                const js = await r.json();
                renderFiles(js.items || []);
            }
        }

        function renderUsers(items) {
            if (!items.length) {
                usersPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }

            usersPane.innerHTML = items.map(u => {
                const statusText = u.is_admin
                    ? 'Admin'
                    : ((u.is_blocked || !u.is_active) ? 'Bloqueado' : 'Activo');

                // Botones de acci√≥n (no mostramos acciones extra si es admin)
                let actionsHtml = `<span class="muted">${escapeHtml(statusText)}</span>`;
                if (!u.is_admin) {
                    if (u.is_blocked || !u.is_active) {
                        actionsHtml += `
              <button class="btn" onclick="unblockUser(${u.id})">Desbloquear</button>
            `;
                    } else {
                        actionsHtml += `
              <button class="btn ghost" onclick="blockUser(${u.id})">Bloquear</button>
            `;
                    }
                    actionsHtml += `
            <button class="btn ghost" onclick="deleteUser(${u.id})">Eliminar</button>
          `;
                }

                // üîç Bot√≥n: Ver detalle del usuario
                actionsHtml += `
          <button class="btn ghost" onclick="window.location='/admin/user/${u.id}'">
            Ver detalle
          </button>
        `;

                return `
          <div class="row-card">
            <div class="row-main">
              <div>
                <strong>${escapeHtml(u.name || '(sin nombre)')}</strong>
                <span class="muted">‚Äî ${escapeHtml(u.email || '')}</span>
              </div>
              <span class="muted">
                ${escapeHtml(u.university || '')} ‚Ä¢ ${escapeHtml(u.faculty || '')} ‚Ä¢ ${escapeHtml(u.career || '')}
              </span>
            </div>
            <div class="right">
              ${actionsHtml}
            </div>
          </div>
        `;
            }).join('');
        }

        function renderNotes(items) {
            if (!items.length) {
                notesPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }
            notesPane.innerHTML = items.map(n => `
        <div class="row-card">
          <div class="row-main">
            <div>
              <strong>${escapeHtml(n.title)}</strong>
              <span class="muted">
                ${n.seller_name ? escapeHtml(n.seller_name) : ''}
              </span>
            </div>
            <span class="muted">
              ${escapeHtml(n.university || '')} ‚Ä¢ ${escapeHtml(n.faculty || '')} ‚Ä¢ ${escapeHtml(n.career || '')}
            </span>
          </div>
          <div class="right">
            <span class="muted">$${(n.price_cents / 100).toFixed(2)}</span>
            <button class="btn ghost" onclick="deleteNote(${n.id})">Eliminar</button>
          </div>
        </div>
      `).join('');
        }

        function renderFiles(items) {
            if (!items.length) {
                filesPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }
            filesPane.innerHTML = items.map(it => `
        <div class="row-card">
          <div class="row-main">
            <div><strong>${escapeHtml(it.title)}</strong></div>
            <span class="muted">
              ${escapeHtml(it.university || '')} ‚Ä¢ ${escapeHtml(it.faculty || '')} ‚Ä¢ ${escapeHtml(it.career || '')}
            </span>
          </div>
          <div class="right">
            <a class="btn" href="${it.download_url}">Descargar PDF</a>
          </div>
        </div>
      `).join('');
        }

        // ---------- Acciones de apuntes ----------
        window.deleteNote = async function (id) {
            if (!confirm('¬øEliminar este apunte?')) return;
            const r = await fetch(`/admin/api/notes/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) { load(); } else { alert('No se pudo eliminar.'); }
        }

        // ---------- Acciones de usuarios ----------
        window.blockUser = async function (id) {
            if (!confirm('¬øBloquear este usuario? No podr√° iniciar sesi√≥n.')) return;
            const r = await fetch(`/admin/api/users/${id}/block`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo bloquear el usuario: ' + (js.error || ''));
            }
        }

        window.unblockUser = async function (id) {
            const r = await fetch(`/admin/api/users/${id}/unblock`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo desbloquear el usuario: ' + (js.error || ''));
            }
        }

        window.deleteUser = async function (id) {
            if (!confirm('¬øEliminar este usuario de forma permanente?')) return;
            const r = await fetch(`/admin/api/users/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else if (js.error === 'has_related_data') {
                alert('No se puede eliminar un usuario con apuntes o compras. Bloquealo en su lugar.');
            } else if (js.error === 'cannot_delete_admin') {
                alert('No pod√©s eliminar un administrador.');
            } else if (js.error === 'cannot_delete_self') {
                alert('No pod√©s eliminar tu propio usuario.');
            } else {
                alert('No se pudo eliminar el usuario.');
            }
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        // primera carga
        load();
    })();
</script>
{% endblock %}