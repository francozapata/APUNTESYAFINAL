{% extends "base.html" %}
{% block content %}
<style>
    .admin-card {
        max-width: 980px;
        margin: 32px auto;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .04);
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
    }

    .tab {
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid #d9d9e3;
        background: #f7f9ff;
        cursor: pointer;
        font-weight: 600
    }

    .tab.active {
        background: #4478ff;
        color: #fff;
        border-color: #4478ff
    }

    .input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d9d9e3;
        border-radius: 10px;
        background: #fff;
        font-size: 15px;
    }

    .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        margin-top: 10px;
    }

    .muted {
        color: #666;
        font-size: 13px
    }

    .btn {
        padding: 8px 12px;
        border: 0;
        border-radius: 10px;
        background: #4478ff;
        color: #fff;
        font-weight: 600;
        cursor: pointer
    }

    .btn.ghost {
        background: #f3f6ff;
        color: #335
    }

    .right {
        display: flex;
        gap: 8px;
        align-items: center
    }
</style>

<div class="admin-card">
    <h2 style="margin:0 0 6px">Administrar AP</h2>

    <div class="tabs">
        <button id="tabUsers" class="tab active">Usuarios</button>
        <button id="tabNotes" class="tab">Apuntes</button>
        <button id="tabFiles" class="tab">Archivos</button><!-- NUEVO -->
    </div>

    <!-- BUSCADOR -->
    <input id="searchBox" class="input" placeholder="Buscar usuario (nombre/email)">

    <!-- CONTENEDORES -->
    <div id="usersPane" style="margin-top:14px;"></div>
    <div id="notesPane" style="display:none;margin-top:14px;"></div>
    <div id="filesPane" style="display:none;margin-top:14px;"></div><!-- NUEVO -->
</div>

<script>
    (function () {
        const tabUsers = document.getElementById('tabUsers');
        const tabNotes = document.getElementById('tabNotes');
        const tabFiles = document.getElementById('tabFiles');
        const searchBox = document.getElementById('searchBox');
        const usersPane = document.getElementById('usersPane');
        const notesPane = document.getElementById('notesPane');
        const filesPane = document.getElementById('filesPane');

        let activeTab = 'users'; // 'users' | 'notes' | 'files'
        let timer = null;

        function sw(tab) {
            activeTab = tab;
            tabUsers.classList.toggle('active', tab === 'users');
            tabNotes.classList.toggle('active', tab === 'notes');
            tabFiles.classList.toggle('active', tab === 'files');

            usersPane.style.display = tab === 'users' ? '' : 'none';
            notesPane.style.display = tab === 'notes' ? '' : 'none';
            filesPane.style.display = tab === 'files' ? '' : 'none';

            searchBox.placeholder =
                tab === 'users' ? 'Buscar usuario (nombre/email)' :
                    tab === 'notes' ? 'Buscar por t√≠tulo, descripci√≥n, universidad, facultad o carrera' :
                        'Buscar archivos por t√≠tulo, universidad, facultad o carrera';

            load();
        }

        tabUsers.addEventListener('click', () => sw('users'));
        tabNotes.addEventListener('click', () => sw('notes'));
        tabFiles.addEventListener('click', () => sw('files'));

        searchBox.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(load, 300);
        });

        async function load() {
            const q = encodeURIComponent(searchBox.value || '');
            if (activeTab === 'users') {
                usersPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/users?q=${q}`);
                const js = await r.json();
                renderUsers(js.items || []);
            } else if (activeTab === 'notes') {
                notesPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/notes?q=${q}`);
                const js = await r.json();
                renderNotes(js.items || []);
            } else {
                filesPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/files?q=${q}`);
                const js = await r.json();
                renderFiles(js.items || []);
            }
        }

        function renderUsers(items) {
            if (!items.length) {
                usersPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }

            usersPane.innerHTML = items.map(u => {
                const statusText = u.is_admin
                    ? 'Admin'
                    : ((u.is_blocked || !u.is_active) ? 'Bloqueado' : 'Activo');

                // Botones de acci√≥n (no mostramos acciones extra si es admin)
                let actionsHtml = `<span class="muted">${escapeHtml(statusText)}</span>`;
                if (!u.is_admin) {
                    if (u.is_blocked || !u.is_active) {
                        actionsHtml += `
                            <button class="btn" onclick="unblockUser(${u.id})">Desbloquear</button>
                        `;
                    } else {
                        actionsHtml += `
                            <button class="btn ghost" onclick="blockUser(${u.id})">Bloquear</button>
                        `;
                    }
                    actionsHtml += `
                        <button class="btn ghost" onclick="deleteUser(${u.id})">Eliminar</button>
                    `;
                }

                // üîç Nuevo bot√≥n: Ver detalle del usuario
                actionsHtml += `
                    <button class="btn ghost" onclick="window.location='/admin/user/${u.id}'">
                        Ver detalle
                    </button>
                `;

                return `
          <div class="row">
            <div>
              <div><strong>${escapeHtml(u.name || '(sin nombre)')}</strong> <span class="muted">‚Äî ${escapeHtml(u.email || '')}</span></div>
              <div class="muted">${escapeHtml(u.university || '')} ‚Ä¢ ${escapeHtml(u.faculty || '')} ‚Ä¢ ${escapeHtml(u.career || '')}</div>
            </div>
            <div class="right">
              ${actionsHtml}
            </div>
          </div>
        `;
            }).join('');
        }

        function renderNotes(items) {
            if (!items.length) { notesPane.innerHTML = '<div class="muted">Sin resultados.</div>'; return; }
            notesPane.innerHTML = items.map(n => `
          <div class="row">
            <div>
              <div><strong>${escapeHtml(n.title)}</strong> <span class="muted">‚Äî ${n.seller_name ? escapeHtml(n.seller_name) : ''}</span></div>
              <div class="muted">${escapeHtml(n.university || '')} ‚Ä¢ ${escapeHtml(n.faculty || '')} ‚Ä¢ ${escapeHtml(n.career || '')}</div>
            </div>
            <div class="right">
              <span class="muted">$${(n.price_cents / 100).toFixed(2)}</span>
              <button class="btn ghost" onclick="deleteNote(${n.id})">Eliminar</button>
            </div>
          </div>
        `).join('');
        }

        function renderFiles(items) {
            if (!items.length) { filesPane.innerHTML = '<div class="muted">Sin resultados.</div>'; return; }
            filesPane.innerHTML = items.map(it => `
          <div class="row">
            <div>
              <div><strong>${escapeHtml(it.title)}</strong></div>
              <div class="muted">${escapeHtml(it.university || '')} ‚Ä¢ ${escapeHtml(it.faculty || '')} ‚Ä¢ ${escapeHtml(it.career || '')}</div>
            </div>
            <div class="right">
              <a class="btn" href="${it.download_url}">Descargar PDF</a>
            </div>
          </div>
        `).join('');
        }

        // ---------- Acciones de apuntes ----------
        window.deleteNote = async function (id) {
            if (!confirm('¬øEliminar este apunte?')) return;
            const r = await fetch(`/admin/api/notes/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) { load(); } else { alert('No se pudo eliminar.'); }
        }

        // ---------- Acciones de usuarios ----------
        window.blockUser = async function (id) {
            if (!confirm('¬øBloquear este usuario? No podr√° iniciar sesi√≥n.')) return;
            const r = await fetch(`/admin/api/users/${id}/block`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo bloquear el usuario: ' + (js.error || ''));
            }
        }

        window.unblockUser = async function (id) {
            const r = await fetch(`/admin/api/users/${id}/unblock`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo desbloquear el usuario: ' + (js.error || ''));
            }
        }

        window.deleteUser = async function (id) {
            if (!confirm('¬øEliminar este usuario de forma permanente?')) return;
            const r = await fetch(`/admin/api/users/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else if (js.error === 'has_related_data') {
                alert('No se puede eliminar un usuario con apuntes o compras. Bloquealo en su lugar.');
            } else if (js.error === 'cannot_delete_admin') {
                alert('No pod√©s eliminar un administrador.');
            } else if (js.error === 'cannot_delete_self') {
                alert('No pod√©s eliminar tu propio usuario.');
            } else {
                alert('No se pudo eliminar el usuario.');
            }
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        // primera carga
        load();
    })();
</script>
{% endblock %}