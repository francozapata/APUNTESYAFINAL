{% extends "base.html" %}
{% block content %}
<style>
    .admin-card {
        max-width: 980px;
        margin: 32px auto;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .04);
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
    }

    .tab {
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid #d9d9e3;
        background: #f7f9ff;
        cursor: pointer;
        font-weight: 600
    }

    .tab.active {
        background: #4478ff;
        color: #fff;
        border-color: #4478ff
    }

    .input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d9d9e3;
        border-radius: 10px;
        background: #fff;
        font-size: 15px;
    }

    .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        margin-top: 10px;
    }

    .muted {
        color: #666;
        font-size: 13px
    }

    .btn {
        padding: 8px 12px;
        border: 0;
        border-radius: 10px;
        background: #4478ff;
        color: #fff;
        font-weight: 600;
        cursor: pointer
    }

    .btn.ghost {
        background: #f3f6ff;
        color: #335
    }

    .right {
        display: flex;
        gap: 8px;
        align-items: center
    }
</style>

<div class="admin-card">
    <h2 style="margin:0 0 6px">Administrar AP</h2>

    <div class="tabs">
        <button id="tabUsers" class="tab active">Usuarios</button>
        <button id="tabNotes" class="tab">Apuntes</button>
    </div>

    <!-- BUSCADOR -->
    <input id="searchBox" class="input" placeholder="Buscar usuario (nombre/email)">

    <!-- CONTENEDORES -->
    <div id="usersPane" style="margin-top:14px;"></div>
    <div id="notesPane" style="display:none;margin-top:14px;"></div>
</div>

<script>
    (function () {
        const tabUsers = document.getElementById('tabUsers');
        const tabNotes = document.getElementById('tabNotes');
        const searchBox = document.getElementById('searchBox');
        const usersPane = document.getElementById('usersPane');
        const notesPane = document.getElementById('notesPane');

        let activeTab = 'users'; // 'users' | 'notes'
        let timer = null;

        function sw(tab) {
            activeTab = tab;
            tabUsers.classList.toggle('active', tab === 'users');
            tabNotes.classList.toggle('active', tab === 'notes');
            usersPane.style.display = tab === 'users' ? '' : 'none';
            notesPane.style.display = tab === 'notes' ? '' : 'none';
            searchBox.placeholder = tab === 'users'
                ? 'Buscar usuario (nombre/email)'
                : 'Buscar por título, descripción, universidad, facultad o carrera';
            load();
        }

        tabUsers.addEventListener('click', () => sw('users'));
        tabNotes.addEventListener('click', () => sw('notes'));

        searchBox.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(load, 300);
        });

        async function load() {
            const q = encodeURIComponent(searchBox.value || '');
            if (activeTab === 'users') {
                usersPane.innerHTML = '<div class="muted">Cargando…</div>';
                const r = await fetch(`/admin/api/users?q=${q}`);
                const js = await r.json();
                renderUsers(js.items || []);
            } else {
                notesPane.innerHTML = '<div class="muted">Cargando…</div>';
                const r = await fetch(`/admin/api/notes?q=${q}`);
                const js = await r.json();
                renderNotes(js.items || []);
            }
        }

        function renderUsers(items) {
            if (!items.length) { usersPane.innerHTML = '<div class="muted">Sin resultados.</div>'; return; }
            usersPane.innerHTML = items.map(u => `
      <div class="row">
        <div>
          <div><strong>${escapeHtml(u.name || '(sin nombre)')}</strong> <span class="muted">— ${escapeHtml(u.email || '')}</span></div>
          <div class="muted">${escapeHtml(u.university || '')} • ${escapeHtml(u.faculty || '')} • ${escapeHtml(u.career || '')}</div>
        </div>
        <div class="right">
          ${u.is_admin ? '<span class="muted">Admin</span>' : ''}
          ${u.is_active ? '<span class="muted">Activo</span>' : '<span class="muted">Inactivo</span>'}
        </div>
      </div>
    `).join('');
        }

        function renderNotes(items) {
            if (!items.length) { notesPane.innerHTML = '<div class="muted">Sin resultados.</div>'; return; }
            notesPane.innerHTML = items.map(n => `
      <div class="row">
        <div>
          <div><strong>${escapeHtml(n.title)}</strong> <span class="muted">— ${n.seller_name ? escapeHtml(n.seller_name) : ''}</span></div>
          <div class="muted">${escapeHtml(n.university || '')} • ${escapeHtml(n.faculty || '')} • ${escapeHtml(n.career || '')}</div>
        </div>
        <div class="right">
          <span class="muted">$${(n.price_cents / 100).toFixed(2)}</span>
          <button class="btn ghost" onclick="deleteNote(${n.id})">Eliminar</button>
        </div>
      </div>
    `).join('');
        }

        window.deleteNote = async function (id) {
            if (!confirm('¿Eliminar este apunte?')) return;
            const r = await fetch(`/admin/api/notes/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) { load(); } else { alert('No se pudo eliminar.'); }
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        // primera carga
        load();
    })();
</script>
{% endblock %}