{% extends "base.html" %}
{% block content %}

<style>
    .admin-shell {
        max-width: 980px;
        margin: 32px auto;
    }

    .admin-card {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e5e7f5;
        padding: 22px 20px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }

    .admin-header {
        margin-bottom: 12px;
    }

    .admin-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }

    .admin-header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: #6b7280;
    }

    /* Tabs */
    .tabs {
        display: inline-flex;
        gap: 6px;
        margin: 12px 0 14px;
        padding: 4px;
        border-radius: 999px;
        background: #f7f9ff;
        border: 1px solid #e0e4ff;
        flex-wrap: wrap;
    }

    .tab {
        padding: 6px 14px;
        border-radius: 999px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        color: #4b5563;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .tab.active {
        background: #4478ff;
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(68, 120, 255, 0.35);
    }

    /* Search */
    .input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d9d9e3;
        border-radius: 999px;
        background: #ffffff;
        font-size: 14px;
    }

    .input::placeholder {
        color: #9ca3af;
    }

    .muted {
        color: #6b7280;
        font-size: 13px;
    }

    /* Cards de filas */
    .row-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid #e5e7f5;
        background: #fafbff;
        margin-top: 10px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
    }

    .row-main {
        min-width: 0;
    }

    .row-main strong {
        font-size: 14px;
        color: #111827;
    }

    .row-main .muted {
        margin-top: 2px;
        display: block;
    }

    .right {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    /* Botones */
    .btn {
        padding: 7px 12px;
        border: 0;
        border-radius: 999px;
        background: #4478ff;
        color: #fff;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none;
        transition: 0.15s;
        white-space: nowrap;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(68, 120, 255, 0.35);
    }

    .btn.ghost {
        background: #f3f6ff;
        color: #334;
        border: 1px solid #dfe4ff;
        box-shadow: none;
    }

    .btn.ghost:hover {
        background: #e4e9ff;
    }

    @media (max-width: 720px) {
        .admin-card {
            padding: 20px 16px;
        }

        .row-card {
            flex-direction: column;
            align-items: flex-start;
        }

        .right {
            width: 100%;
            justify-content: flex-start;
        }
    }
</style>

<div class="admin-shell">
    <div class="admin-card">
        <div class="admin-header">
            <h2>Administrar ApuntesYa</h2>
            <p>Busc√° y gestion√° usuarios, apuntes y archivos desde un solo lugar.</p>
        </div>

        <div class="tabs">
            <button id="tabUsers" class="tab active">üë• <span>Usuarios</span></button>
            <button id="tabContent" class="tab">üìö <span>Apuntes y archivos</span></button>
            <button id="tabModeration" class="tab">üõ°Ô∏è <span>Moderador</span></button>
        </div>

        <!-- BUSCADOR -->
        <input id="searchBox" class="input" placeholder="Buscar usuario (nombre/email)">

        <!-- CONTENEDORES -->
        <div id="usersPane" style="margin-top:14px;"></div>
        <div id="contentPane" style="display:none;margin-top:14px;"></div>
        <div id="moderationPane" style="display:none;margin-top:14px;">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                <button class="btn ghost" id="modStatusPendingAi">Pendientes IA</button>
                <button class="btn ghost" id="modStatusPendingManual">Revisi√≥n manual</button>
                <button class="btn ghost" id="modStatusApproved">Aprobados</button>
                <button class="btn ghost" id="modStatusRejected">Rechazados</button>
            </div>
            <div id="moderationList"></div>
        </div>
    </div>
</div>

<script>
    (function () {
        const tabUsers = document.getElementById('tabUsers');
        const tabContent = document.getElementById('tabContent');
        const tabModeration = document.getElementById('tabModeration');
        const searchBox = document.getElementById('searchBox');
        const usersPane = document.getElementById('usersPane');
        const contentPane = document.getElementById('contentPane');
        const moderationPane = document.getElementById('moderationPane');
        const moderationList = document.getElementById('moderationList');

        const modStatusPendingAi = document.getElementById('modStatusPendingAi');
        const modStatusPendingManual = document.getElementById('modStatusPendingManual');
        const modStatusApproved = document.getElementById('modStatusApproved');
        const modStatusRejected = document.getElementById('modStatusRejected');

        let activeTab = 'users'; // 'users' | 'content' | 'moderation'
        let moderationStatus = 'pending_manual';
        let timer = null;

        function sw(tab) {
            activeTab = tab;
            tabUsers.classList.toggle('active', tab === 'users');
            tabContent.classList.toggle('active', tab === 'content');
            tabModeration.classList.toggle('active', tab === 'moderation');

            usersPane.style.display = tab === 'users' ? '' : 'none';
            contentPane.style.display = tab === 'content' ? '' : 'none';
            moderationPane.style.display = tab === 'moderation' ? '' : 'none';

            searchBox.placeholder =
                tab === 'users'
                    ? 'Buscar usuario (nombre/email)'
                    : (tab === 'content'
                        ? 'Buscar por t√≠tulo, descripci√≥n, universidad, facultad o carrera'
                        : 'Buscar por t√≠tulo o vendedor');

            load();
        }

        tabUsers.addEventListener('click', () => sw('users'));
        tabContent.addEventListener('click', () => sw('content'));
        tabModeration.addEventListener('click', () => sw('moderation'));

        function setModStatus(st) {
            moderationStatus = st;
            // visual: marcar el bot√≥n activo usando el mismo look de .btn.ghost
            const map = {
                pending_ai: modStatusPendingAi,
                pending_manual: modStatusPendingManual,
                approved: modStatusApproved,
                rejected: modStatusRejected,
            };
            Object.values(map).forEach(b => {
                b.style.background = '#f3f6ff';
                b.style.borderColor = '#dfe4ff';
                b.style.color = '#334';
                b.style.boxShadow = 'none';
            });
            const btn = map[st];
            if (btn) {
                btn.style.background = '#4478ff';
                btn.style.borderColor = '#4478ff';
                btn.style.color = '#fff';
                btn.style.boxShadow = '0 8px 18px rgba(68, 120, 255, 0.35)';
            }
            load();
        }

        modStatusPendingAi.addEventListener('click', () => setModStatus('pending_ai'));
        modStatusPendingManual.addEventListener('click', () => setModStatus('pending_manual'));
        modStatusApproved.addEventListener('click', () => setModStatus('approved'));
        modStatusRejected.addEventListener('click', () => setModStatus('rejected'));

        searchBox.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(load, 300);
        });

        async function load() {
            const q = encodeURIComponent(searchBox.value || '');
            if (activeTab === 'users') {
                usersPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/users?q=${q}`);
                const js = await r.json();
                renderUsers(js.items || []);
            } else if (activeTab === 'content') {
                contentPane.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/content?q=${q}`);
                const js = await r.json();
                renderContent(js.items || []);
            } else {
                moderationList.innerHTML = '<div class="muted">Cargando‚Ä¶</div>';
                const r = await fetch(`/admin/api/moderation?status=${encodeURIComponent(moderationStatus)}&q=${q}`);
                const js = await r.json();
                renderModeration(js.notes || [], js.combos || []);
            }
        }

        function renderModeration(notes, combos) {
            const blocks = [];

            // Notes
            if (notes.length) {
                blocks.push(`<div class="muted" style="margin:6px 0 4px;font-weight:700;">Apuntes</div>`);
                blocks.push(notes.map(n => {
                    const price = (n.price_cents || 0) === 0 ? 'Gratis' : `$${((n.price_cents || 0) / 100).toFixed(2)}`;
                    const ai = n.ai_decision ? `${escapeHtml(n.ai_decision)}${(n.ai_confidence !== null && n.ai_confidence !== undefined) ? ` <span class="muted">(${Math.round((n.ai_confidence || 0) / 10)}%)</span>` : ''}` : '<span class="muted">-</span>';
                    const reason = n.moderation_reason ? `<div class="muted" style="margin-top:6px;">Motivo: ${escapeHtml(n.moderation_reason)}</div>` : '';
                    const seller = n.seller_name ? `<span class="muted">${escapeHtml(n.seller_name)}</span>` : '';
                    const actions = `
                        ${n.moderation_status !== 'approved' ? `<button class="btn" onclick="approveNote(${n.id})">Aprobar</button>` : ''}
                        ${n.moderation_status !== 'rejected' ? `<button class="btn ghost" onclick="rejectNote(${n.id})">Rechazar</button>` : ''}
                        <a class="btn ghost" href="/note/${n.id}" target="_blank" rel="noopener noreferrer">Ver</a>
                    `;
                    return `
                        <div class="row-card">
                            <div class="row-main">
                                <div>
                                    <strong>${escapeHtml(n.title || '(sin t√≠tulo)')}</strong>
                                    ${seller}
                                </div>
                                <span class="muted">${escapeHtml(n.university || '')} ‚Ä¢ ${escapeHtml(n.faculty || '')} ‚Ä¢ ${escapeHtml(n.career || '')}</span>
                                <div class="muted" style="margin-top:6px;display:flex;gap:14px;flex-wrap:wrap;">
                                    <span><b>Precio:</b> ${price}</span>
                                    <span><b>IA:</b> ${ai}</span>
                                    <span><b>Estado:</b> ${escapeHtml(n.moderation_status || '')}</span>
                                </div>
                                ${reason}
                            </div>
                            <div class="right">${actions}</div>
                        </div>
                    `;
                }).join(''));
            } else {
                blocks.push('<div class="muted">No hay apuntes en este estado.</div>');
            }

            // Combos
            blocks.push('<hr style="margin:18px 0;border:none;border-top:1px solid #e5e7f5;">');
            if (combos.length) {
                blocks.push(`<div class="muted" style="margin:6px 0 4px;font-weight:700;">Combos</div>`);
                blocks.push(combos.map(c => {
                    const price = (c.price_cents || 0) === 0 ? 'Gratis' : `$${((c.price_cents || 0) / 100).toFixed(2)}`;
                    const ai = c.ai_decision ? `${escapeHtml(c.ai_decision)}${(c.ai_confidence !== null && c.ai_confidence !== undefined) ? ` <span class="muted">(${Math.round((c.ai_confidence || 0) / 10)}%)</span>` : ''}` : '<span class="muted">-</span>';
                    const reason = c.moderation_reason ? `<div class="muted" style="margin-top:6px;">Motivo: ${escapeHtml(c.moderation_reason)}</div>` : '';
                    const seller = c.seller_name ? `<span class="muted">${escapeHtml(c.seller_name)}</span>` : '';
                    const actions = `
                        ${c.moderation_status !== 'approved' ? `<button class="btn" onclick="approveCombo(${c.id})">Aprobar</button>` : ''}
                        ${c.moderation_status !== 'rejected' ? `<button class="btn ghost" onclick="rejectCombo(${c.id})">Rechazar</button>` : ''}
                        <a class="btn ghost" href="/combo/${c.id}" target="_blank" rel="noopener noreferrer">Ver</a>
                    `;
                    return `
                        <div class="row-card">
                            <div class="row-main">
                                <div>
                                    <strong>${escapeHtml(c.title || '(sin t√≠tulo)')}</strong>
                                    ${seller}
                                </div>
                                <div class="muted" style="margin-top:6px;display:flex;gap:14px;flex-wrap:wrap;">
                                    <span><b>Precio:</b> ${price}</span>
                                    <span><b>IA:</b> ${ai}</span>
                                    <span><b>Estado:</b> ${escapeHtml(c.moderation_status || '')}</span>
                                </div>
                                ${reason}
                            </div>
                            <div class="right">${actions}</div>
                        </div>
                    `;
                }).join(''));
            } else {
                blocks.push('<div class="muted">No hay combos en este estado.</div>');
            }

            moderationList.innerHTML = blocks.join('');
        }

        window.approveNote = async function (id) {
            const r = await fetch(`/admin/moderation/${id}/approve`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) load(); else alert('No se pudo aprobar.');
        }

        window.rejectNote = async function (id) {
            const reason = prompt('Motivo de rechazo (opcional):') || '';
            const r = await fetch(`/admin/moderation/${id}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) load(); else alert('No se pudo rechazar.');
        }

        window.approveCombo = async function (id) {
            const r = await fetch(`/admin/moderation/combo/${id}/approve`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) load(); else alert('No se pudo aprobar el combo.');
        }

        window.rejectCombo = async function (id) {
            const reason = prompt('Motivo de rechazo (opcional):') || '';
            const fd = new FormData();
            fd.append('reason', reason);
            const r = await fetch(`/admin/moderation/combo/${id}/reject`, { method: 'POST', body: fd });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) load(); else alert('No se pudo rechazar el combo.');
        }

        function renderUsers(items) {
            if (!items.length) {
                usersPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }

            usersPane.innerHTML = items.map(u => {
                const statusText = u.is_admin
                    ? 'Admin'
                    : ((u.is_blocked || !u.is_active) ? 'Bloqueado' : 'Activo');

                // Botones de acci√≥n (no mostramos acciones extra si es admin)
                let actionsHtml = `<span class="muted">${escapeHtml(statusText)}</span>`;
                if (!u.is_admin) {
                    if (u.is_blocked || !u.is_active) {
                        actionsHtml += `
              <button class="btn" onclick="unblockUser(${u.id})">Desbloquear</button>
            `;
                    } else {
                        actionsHtml += `
              <button class="btn ghost" onclick="blockUser(${u.id})">Bloquear</button>
            `;
                    }
                    actionsHtml += `
            <button class="btn ghost" onclick="deleteUser(${u.id})">Eliminar</button>
          `;
                }

                // üîç Bot√≥n: Ver detalle del usuario
                actionsHtml += `
          <button class="btn ghost" onclick="window.location='/admin/user/${u.id}'">
            Ver detalle
          </button>
        `;

                return `
          <div class="row-card">
            <div class="row-main">
              <div>
                <strong>${escapeHtml(u.name || '(sin nombre)')}</strong>
                <span class="muted">‚Äî ${escapeHtml(u.email || '')}</span>
              </div>
              <span class="muted">
                ${escapeHtml(u.university || '')} ‚Ä¢ ${escapeHtml(u.faculty || '')} ‚Ä¢ ${escapeHtml(u.career || '')}
              </span>
            </div>
            <div class="right">
              ${actionsHtml}
            </div>
          </div>
        `;
            }).join('');
        }

        function renderContent(items) {
            if (!items.length) {
                contentPane.innerHTML = '<div class="muted">Sin resultados.</div>';
                return;
            }

            contentPane.innerHTML = items.map(it => `
        <div class="row-card">
          <div class="row-main">
            <div>
              <strong>${escapeHtml(it.title)}</strong>
              ${it.seller_name ? `<span class="muted">${escapeHtml(it.seller_name)}</span>` : ''}
            </div>
            <span class="muted">
              ${escapeHtml(it.university || '')} ‚Ä¢ ${escapeHtml(it.faculty || '')} ‚Ä¢ ${escapeHtml(it.career || '')}
            </span>
            ${it.file_path ? `<span class="muted">Archivo: ${escapeHtml(it.file_path)}</span>` : ''}
          </div>
          <div class="right">
            <span class="muted">$${((it.price_cents || 0) / 100).toFixed(2)}</span>
            <a class="btn" href="${it.download_url}">Descargar</a>
            <button class="btn ghost" onclick="deleteContent(${it.id})">Borrar</button>
          </div>
        </div>
      `).join('');
        }

        // ---------- Acciones de contenido (apunte + archivo) ----------
        window.deleteContent = async function (id) {
            if (!confirm('¬øBorrar este apunte y su archivo asociado?')) return;
            const r = await fetch(`/admin/api/content/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) { load(); } else { alert('No se pudo borrar.'); }
        }

        // ---------- Acciones de usuarios ----------
        window.blockUser = async function (id) {
            if (!confirm('¬øBloquear este usuario? No podr√° iniciar sesi√≥n.')) return;
            const r = await fetch(`/admin/api/users/${id}/block`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo bloquear el usuario: ' + (js.error || ''));
            }
        }

        window.unblockUser = async function (id) {
            const r = await fetch(`/admin/api/users/${id}/unblock`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else {
                alert('No se pudo desbloquear el usuario: ' + (js.error || ''));
            }
        }

        window.deleteUser = async function (id) {
            if (!confirm('¬øEliminar este usuario de forma permanente?')) return;
            const r = await fetch(`/admin/api/users/${id}/delete`, { method: 'POST' });
            const js = await r.json().catch(() => ({ ok: false }));
            if (js.ok) {
                load();
            } else if (js.error === 'has_related_data') {
                alert('No se puede eliminar un usuario con apuntes o compras. Bloquealo en su lugar.');
            } else if (js.error === 'cannot_delete_admin') {
                alert('No pod√©s eliminar un administrador.');
            } else if (js.error === 'cannot_delete_self') {
                alert('No pod√©s eliminar tu propio usuario.');
            } else {
                alert('No se pudo eliminar el usuario.');
            }
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        // primera carga
        setModStatus('pending_manual');
        load();
    })();
</script>
{% endblock %}