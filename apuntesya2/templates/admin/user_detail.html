{% extends "base.html" %}
{% block content %}
<style>
    .admin-card {
        max-width: 980px;
        margin: 32px auto;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .04);
    }

    .muted {
        color: #666;
        font-size: 14px;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 14px;
    }

    .stat-card {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #eee;
        background: #fafbff;
    }

    .stat-label {
        font-size: 13px;
        color: #777;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        margin-top: 2px;
    }

    .stat-extra {
        font-size: 13px;
        color: #666;
        margin-top: 2px;
    }

    .summary-box {
        margin-top: 18px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px dashed #d0d4ff;
        background: #f6f7ff;
        font-size: 14px;
        line-height: 1.5;
    }
</style>

<div class="admin-card" id="userDetailRoot" data-user-id="{{ user_id|int }}">
    <h2 style="margin:0 0 6px;">Detalle de usuario #{{ user_id }}</h2>
    <p class="muted" id="userBasic">Cargando datos…</p>

    <div class="stat-grid" id="userStats" style="display:none;">
        <!-- Apuntes subidos -->
        <div class="stat-card">
            <div class="stat-label">Apuntes subidos</div>
            <div class="stat-value" id="st-notes-uploaded">-</div>
            <div class="stat-extra" id="st-notes-extra"></div>
        </div>

        <!-- Compras pagas -->
        <div class="stat-card">
            <div class="stat-label">Compras pagas</div>
            <div class="stat-value" id="st-paid-count">-</div>
            <div class="stat-extra" id="st-paid-amount"></div>
        </div>

        <!-- Descargas gratuitas -->
        <div class="stat-card">
            <div class="stat-label">Descargas gratuitas</div>
            <div class="stat-value" id="st-free-count">-</div>
        </div>

        <!-- Ventas como vendedor -->
        <div class="stat-card">
            <div class="stat-label">Ventas realizadas</div>
            <div class="stat-value" id="st-sold-count">-</div>
            <div class="stat-extra" id="st-sold-amount"></div>
        </div>

        <!-- Ganancia neta del usuario -->
        <div class="stat-card">
            <div class="stat-label">Ganancia recibida (neto)</div>
            <div class="stat-value" id="st-net-seller">$0.00</div>
            <div class="stat-extra" id="st-net-extra"></div>
        </div>

        <!-- Ingresos ApuntesYa por este usuario -->
        <div class="stat-card">
            <div class="stat-label">Ingreso ApuntesYa (ventas de este usuario)</div>
            <div class="stat-value" id="st-apy-income">$0.00</div>
            <div class="stat-extra" id="st-apy-extra"></div>
        </div>
    </div>

    <div id="userSummary" class="summary-box" style="display:none;"></div>
</div>

<script>
    (async function () {
        const root = document.getElementById('userDetailRoot');
        const userId = parseInt(root.dataset.userId, 10);

        try {
            const r = await fetch(`/admin/api/users/${userId}/detail`);
            const js = await r.json();
            if (!js.ok) {
                document.getElementById('userBasic').innerText = 'No se pudo cargar el usuario.';
                return;
            }

            const u = js.user;
            const st = js.stats || {};

            const created = u.created_at ? new Date(u.created_at).toLocaleString() : 'N/D';
            const statusParts = [];
            if (u.is_admin) statusParts.push('Admin');
            if (u.is_blocked || !u.is_active) statusParts.push('Bloqueado');
            if (!statusParts.length) statusParts.push('Activo');

            // Cabecera básica
            document.getElementById('userBasic').innerHTML =
                `<strong>${escapeHtml(u.name || '(sin nombre)')}</strong> — ${escapeHtml(u.email || '')}<br>` +
                `<span class="muted">${escapeHtml(u.university || '')} • ${escapeHtml(u.faculty || '')} • ${escapeHtml(u.career || '')}</span><br>` +
                `<span class="muted">Creado: ${created} — Estado: ${statusParts.join(', ')}</span>`;

            document.getElementById('userStats').style.display = '';
            document.getElementById('userSummary').style.display = '';

            // ---- Stats numéricos ----
            const notesUploaded = st.notes_uploaded_count ?? 0;
            document.getElementById('st-notes-uploaded').innerText = notesUploaded;
            document.getElementById('st-notes-extra').innerText =
                notesUploaded > 0 ? 'Apuntes activos subidos a la plataforma.' : 'Todavía no subió apuntes.';

            // Compras pagas
            const paidCount = st.paid_purchases_count ?? 0;
            const paidAmt = (st.paid_purchases_cents || 0) / 100;
            document.getElementById('st-paid-count').innerText = paidCount;
            document.getElementById('st-paid-amount').innerText =
                paidAmt > 0
                    ? `Total pagado: $${paidAmt.toFixed(2)}`
                    : 'Sin compras pagas.';

            // Descargas gratuitas
            const freeCount = st.free_downloads_count ?? 0;
            document.getElementById('st-free-count').innerText = freeCount;

            // Ventas como vendedor
            const soldCount = st.sold_notes_count ?? 0;
            const soldGross = (st.sold_gross_cents || 0) / 100;
            document.getElementById('st-sold-count').innerText = soldCount;
            document.getElementById('st-sold-amount').innerText =
                soldGross > 0
                    ? `Total vendido (bruto): $${soldGross.toFixed(2)}`
                    : 'Sin ventas registradas.';

            // Comisiones y neto
            const mp = (st.mp_commission_cents || 0) / 100;
            const apy = (st.apy_commission_cents || 0) / 100;
            const net = (st.net_cents_for_seller || 0) / 100;

            document.getElementById('st-net-seller').innerText = `$${net.toFixed(2)}`;
            document.getElementById('st-net-extra').innerText =
                soldGross > 0
                    ? `Sobre $${soldGross.toFixed(2)} vendidos, recibió en su cuenta $${net.toFixed(2)}.`
                    : 'Sin ingresos como vendedor.';

            document.getElementById('st-apy-income').innerText = `$${apy.toFixed(2)}`;
            document.getElementById('st-apy-extra').innerText =
                soldGross > 0
                    ? `Comisión total de ApuntesYa sobre sus ventas.`
                    : 'Aún no generó ingresos para ApuntesYa como vendedor.';

            // ---- Resumen textual general ----
            const totalMovido = soldGross + paidAmt;
            const summaryLines = [];

            summaryLines.push(
                `• Movió en total $${totalMovido.toFixed(2)} en la plataforma `
                + `(compras pagas + ventas brutas).`
            );

            summaryLines.push(
                `• Pagó $${paidAmt.toFixed(2)} en apuntes de otros usuarios.`
            );

            summaryLines.push(
                `• Vendió $${soldGross.toFixed(2)} en apuntes propios y recibió `
                + `$${net.toFixed(2)} netos.`
            );

            summaryLines.push(
                `• ApuntesYa obtuvo $${apy.toFixed(2)} en comisiones por sus ventas.`
            );

            if (freeCount > 0) {
                summaryLines.push(
                    `• Además realizó ${freeCount} descarga(s) de apuntes gratuitos.`
                );
            }

            document.getElementById('userSummary').innerHTML =
                `<strong>Resumen de actividad:</strong><br>${summaryLines.join('<br>')}`;

        } catch (e) {
            console.error(e);
            document.getElementById('userBasic').innerText = 'Error al cargar el detalle.';
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }
    })();
</script>
{% endblock %}