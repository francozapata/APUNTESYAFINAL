{% extends "base.html" %}
{% block content %}

<style>
    .admin-card {
        max-width: 980px;
        margin: 32px auto;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, .04);
    }

    .muted {
        color: #666;
        font-size: 13px;
    }

    .section-title {
        margin: 18px 0 8px;
        font-size: 16px;
    }

    .pill {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #d9d9e3;
        background: #f7f9ff;
        margin-right: 4px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
    }

    .kpi-box {
        border-radius: 10px;
        border: 1px solid #f0f0f5;
        padding: 10px 12px;
    }

    .kpi-label {
        font-size: 12px;
        color: #888;
    }

    .kpi-value {
        font-size: 18px;
        font-weight: 600;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 13px;
    }

    th,
    td {
        padding: 6px 4px;
        border-bottom: 1px solid #f3f3f3;
        text-align: left;
    }

    .btn-pill {
        display: inline-block;
        padding: 7px 12px;
        border-radius: 999px;
        border: 0;
        background: #f3f6ff;
        color: #335;
        font-weight: 600;
        font-size: 13px;
        text-decoration: none;
    }
</style>

<div class="admin-card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <div>
            <h2 style="margin:0 0 4px;">Detalle de usuario</h2>
            <p class="muted" style="margin:0;">
                {{ user.name or '(sin nombre)' }} — {{ user.email }}
            </p>
            <p class="muted" style="margin:4px 0 0;">
                {{ user.university or 'Universidad no indicada' }} •
                {{ user.faculty or 'Facultad no indicada' }} •
                {{ user.career or 'Carrera no indicada' }}
            </p>
        </div>
        <div>
            {% if user.is_admin %}
            <span class="pill">Admin</span>
            {% endif %}
            {% if user.is_active %}
            <span class="pill">Activo</span>
            {% else %}
            <span class="pill">Inactivo / bloqueado</span>
            {% endif %}
            {% if is_seller %}
            <span class="pill">Vendedor ({{ notes_count }} apuntes)</span>
            {% else %}
            <span class="pill">Solo comprador</span>
            {% endif %}
        </div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #f0f0f5;">

    <!-- Resumen global -->
    <h3 class="section-title">Resumen del impacto en la plataforma</h3>
    <div class="grid-2">
        <div class="kpi-box">
            <div class="kpi-label">Total vendido por este usuario</div>
            <div class="kpi-value">
                ${{ '%.2f' % (seller_total_cents / 100.0) }}
            </div>
            <div class="muted" style="margin-top:4px;">
                (Monto que él/ella efectivamente recibe por sus ventas)
            </div>
        </div>
        <div class="kpi-box">
            <div class="kpi-label">Ingresos ApuntesYa por sus ventas</div>
            <div class="kpi-value">
                ${{ '%.2f' % (platform_from_seller_cents / 100.0) }}
            </div>
            <div class="muted" style="margin-top:4px;">
                Comisión sobre las ventas de este usuario.
            </div>
        </div>
        <div class="kpi-box">
            <div class="kpi-label">Total comprado por este usuario (base vendedores)</div>
            <div class="kpi-value">
                ${{ '%.2f' % (buyer_total_cents / 100.0) }}
            </div>
            <div class="muted" style="margin-top:4px;">
                Suma de los precios configurados por los vendedores en los apuntes que compró.
            </div>
        </div>
        <div class="kpi-box">
            <div class="kpi-label">Ingresos ApuntesYa por sus compras</div>
            <div class="kpi-value">
                ${{ '%.2f' % (platform_from_buyer_cents / 100.0) }}
            </div>
            <div class="muted" style="margin-top:4px;">
                Comisión de ApuntesYa asociada a las compras que hizo.
            </div>
        </div>
    </div>

    <!-- Actividad como comprador -->
    <h3 class="section-title" style="margin-top:22px;">Actividad como comprador</h3>
    <p class="muted" style="margin:0 0 6px;">
        Apuntes pagos comprados: <strong>{{ buyer_paid_count }}</strong> <br>
        Descargas gratuitas (no registradas aún): <strong>{{ free_downloads_count }}</strong>
    </p>

    {% if purchases %}
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Apunte</th>
                <th>Monto base ($)</th>
            </tr>
        </thead>
        <tbody>
            {% for p in purchases %}
            <tr>
                <td>{{ p.created_at.strftime('%d/%m/%Y %H:%M') if p.created_at else '' }}</td>
                <td>{{ p.note_title }}</td>
                <td>{{ '%.2f' % (p.amount_cents / 100.0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">Todavía no registramos compras pagas de este usuario.</p>
    {% endif %}

    <!-- Actividad como vendedor -->
    <h3 class="section-title" style="margin-top:22px;">Actividad como vendedor</h3>

    {% if is_seller %}
    <p class="muted" style="margin:0 0 6px;">
        Apuntes vendidos: <strong>{{ seller_sales_count }}</strong><br>
        Total recibido: <strong>${{ '%.2f' % (seller_total_cents / 100.0) }}</strong>
    </p>

    {% if sales %}
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Apunte</th>
                <th>Monto recibido ($)</th>
            </tr>
        </thead>
        <tbody>
            {% for s_item in sales %}
            <tr>
                <td>{{ s_item.created_at.strftime('%d/%m/%Y %H:%M') if s_item.created_at else '' }}</td>
                <td>{{ s_item.note_title }}</td>
                <td>{{ '%.2f' % (s_item.amount_cents / 100.0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">Aún no registramos ventas para este usuario.</p>
    {% endif %}

    {% else %}
    <p class="muted">Este usuario aún no tiene apuntes publicados ni ventas registradas.</p>
    {% endif %}

    <div style="margin-top:20px;">
        <a href="{{ url_for('admin_hub') }}" class="btn-pill">Volver al Hub</a>
    </div>
</div>

{% endblock %}