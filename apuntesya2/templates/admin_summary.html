{% extends "admin/dashboard.html" %}
{% block content %}
<h1>üìä Panel de Sumario General</h1>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px;">
    <div class="card">
        <h3>Usuarios</h3>
        <p>{{ total_users }}</p>
    </div>
    <div class="card">
        <h3>Apuntes</h3>
        <p>{{ total_notes }}</p>
    </div>
    <div class="card">
        <h3>Compras totales</h3>
        <p>{{ total_purchases }}</p>
    </div>
    <div class="card">
        <h3>Pagos aprobados</h3>
        <p>{{ total_approved }}</p>
    </div>
    <div class="card">
        <h3>Pagos pendientes</h3>
        <p>{{ total_pending }}</p>
    </div>
    <div class="card">
        <h3>Pagos rechazados</h3>
        <p>{{ total_rejected }}</p>
    </div>
</div>

<h3 style="margin-top:20px;">üí∞ Totales</h3>
<ul>
    <li>Bruto total: ${{ "%.2f"|format((gross_cents or 0)/100) }}</li>
    <li>Comisi√≥n Mercado Pago: ${{ "%.2f"|format((mp_commission_cents or 0)/100) }}</li>
    <li>Comisi√≥n ApuntesYa: ${{ "%.2f"|format((apy_commission_cents or 0)/100) }}</li>
    <li><strong>Ganancia neta: ${{ "%.2f"|format((net_cents or 0)/100) }}</strong></li>
</ul>

<h3 style="margin-top:24px;">üèÜ Top 10 apuntes vendidos</h3>
<table class="table" style="width:100%;border-collapse:collapse;">
    <thead>
        <tr>
            <th>T√≠tulo</th>
            <th>Vendidos</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        {% for n in top_notes %}
        <tr>
            <td>{{ n.title }}</td>
            <td style="text-align:center;">{{ n.sold_count }}</td>
            <td style="text-align:right;">${{ "%.2f"|format((n.gross_cents or 0)/100) }}</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="3">Sin ventas registradas</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if reported_notes %}
<h3 style="margin-top:24px;">üö® √öltimos apuntes reportados</h3>
<ul>
    {% for r in reported_notes %}
    <li>{{ r.title }} (ID {{ r.id }})</li>
    {% endfor %}
</ul>
{% endif %}

<h3 style="margin-top:24px;">üïí √öltimas compras</h3>
<table class="table" style="width:100%;border-collapse:collapse;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Fecha</th>
            <th>Apunte</th>
        </tr>
    </thead>
    <tbody>
        {% for p in last_purchases %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.status }}</td>
            <td>${{ "%.2f"|format((p.amount_cents or 0)/100) }}</td>
            <td>{{ p.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
            <td>{{ p.title }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<hr>
<h2>Actividad √∫ltimos 30 d√≠as</h2>

<div style="max-width: 980px; margin: 12px 0;">
    <canvas id="salesChart"></canvas>
</div>

<div style="max-width: 980px; margin: 12px 0;">
    <canvas id="revenueChart"></canvas>
</div>

<!-- Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Datos desde el servidor (safe) 
    const LABELS = {{ labels| tojson }};
    const SALES = {{ sales_series| tojson }};
    const REVENUE = {{ revenue_series_ars| tojson }};

    // Ventas (unidades)
    new Chart(document.getElementById('salesChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: LABELS,
            datasets: [{
                label: 'Ventas (unid.)',
                data: SALES,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: 'Fecha' } },
                y: { title: { display: true, text: 'Cantidad' }, beginAtZero: true, precision: 0 }
            }
        }
    });

    // Ingresos ($ ARS)
    new Chart(document.getElementById('revenueChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: LABELS,
            datasets: [{
                label: 'Ingresos (ARS)',
                data: REVENUE,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: 'Fecha' } },
                y: { title: { display: true, text: '$' }, beginAtZero: true }
            }
        }
    });
</script>

{% endblock %}