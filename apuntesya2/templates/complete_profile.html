{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:900px;margin:32px auto">
    <h2>{{ 'Actualizar datos académicos' if mode == 'update' else 'Completá tu perfil' }}</h2>
    {% if name %}<p class="lead">¡Hola {{ name }}! Necesitamos estos datos para organizar los apuntes.</p>{% endif %}

    <form action="{{ url_for('update_academics_post') if mode == 'update' else url_for('complete_profile') }}"
        method="post" id="complete-profile-form">

        <!-- Universidad -->
        <label for="cp-uni">Universidad</label>
        <select id="cp-uni" class="input" required>
            <option value="" disabled selected>Elegí tu Universidad</option>
            <!-- opciones dinámicas -->
            <option value="__other__">Otra…</option>
        </select>
        <input id="cp-uni-other" class="input" placeholder="Escribí el nombre de la Universidad"
            style="display:none;margin-top:8px;">

        <!-- Facultad -->
        <label for="cp-fac" style="margin-top:14px;display:block;">Facultad</label>
        <select id="cp-fac" class="input" required disabled>
            <option value="" disabled selected>Elegí tu Facultad</option>
            <option value="__other__">Otra…</option>
        </select>
        <input id="cp-fac-other" class="input" placeholder="Escribí el nombre de la Facultad"
            style="display:none;margin-top:8px;">

        <!-- Carrera -->
        <label for="cp-car" style="margin-top:14px;display:block;">Carrera</label>
        <select id="cp-car" class="input" required disabled>
            <option value="" disabled selected>Elegí tu Carrera</option>
            <option value="__other__">Otra…</option>
        </select>
        <input id="cp-car-other" class="input" placeholder="Escribí el nombre de la Carrera"
            style="display:none;margin-top:8px;">

        <!-- Estos 3 hidden son lo que llega a Flask y se guarda en User -->
        <input type="hidden" id="cp-hidden-university" name="university">
        <input type="hidden" id="cp-hidden-faculty" name="faculty">
        <input type="hidden" id="cp-hidden-career" name="career">

        <button type="submit" class="btn primary" style="margin-top:16px;">
            {{ 'Guardar cambios' if mode == 'update' else 'Guardar y continuar' }}
        </button>
        <p class="muted" style="margin-top:10px">Podrás editar esta información luego desde tu perfil.</p>
    </form>
</div>

<script>
    // Helpers de DOM
    const $ = (id) => document.getElementById(id);

    // Cargar listas
    async function loadUniversities() {
        const r = await fetch('/api/academics/universities');
        const list = await r.json();
        // Insertar antes de "Otra…"
        const sel = $('cp-uni');
        const other = Array.from(sel.options).find(o => o.value === '__other__');
        list.forEach(u => {
            const opt = document.createElement('option');
            opt.value = String(u.id);
            opt.textContent = u.name;
            sel.insertBefore(opt, other);
        });
    }

    async function loadFaculties(universityId) {
        $('cp-fac').innerHTML = `
      <option value="" disabled selected>Elegí tu Facultad</option>
      <option value="__other__">Otra…</option>`;
        $('cp-fac').disabled = !universityId;

        if (!universityId) return;
        const r = await fetch('/api/academics/faculties?university_id=' + encodeURIComponent(universityId));
        const list = await r.json();
        const sel = $('cp-fac');
        const other = Array.from(sel.options).find(o => o.value === '__other__');
        list.forEach(f => {
            const opt = document.createElement('option');
            opt.value = String(f.id);
            opt.textContent = f.name;
            sel.insertBefore(opt, other);
        });
    }

    async function loadCareers(facultyId) {
        $('cp-car').innerHTML = `
      <option value="" disabled selected>Elegí tu Carrera</option>
      <option value="__other__">Otra…</option>`;
        $('cp-car').disabled = !facultyId;

        if (!facultyId) return;
        const r = await fetch('/api/academics/careers?faculty_id=' + encodeURIComponent(facultyId));
        const list = await r.json();
        const sel = $('cp-car');
        const other = Array.from(sel.options).find(o => o.value === '__other__');
        list.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = c.name;
            sel.insertBefore(opt, other);
        });
    }

    // Mostrar/ocultar inputs "Otra…"
    function toggleOther(selectEl, otherInputId) {
        const show = selectEl.value === '__other__';
        const input = $(otherInputId);
        input.style.display = show ? '' : 'none';
        if (show) input.focus();
        if (!show) input.value = '';
    }

    // Copiar al hidden lo elegido (texto final que guarda User)
    function setHiddenFromSelect(selectEl, otherInputEl, hiddenEl) {
        if (!selectEl.value) return false;
        if (selectEl.value === '__other__') {
            const v = (otherInputEl.value || '').trim();
            if (!v) return false;
            hiddenEl.value = v;
            return true;
        } else {
            hiddenEl.value = selectEl.options[selectEl.selectedIndex].textContent;
            return true;
        }
    }

    // Crear “Otra…” si corresponde
    async function createUniversityIfOther() {
        if ($('cp-uni').value !== '__other__') return { id: Number($('cp-uni').value) || null };
        const name = ($('cp-uni-other').value || '').trim();
        const r = await fetch('/api/academics/universities', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        const js = await r.json();
        if (!r.ok || !js.id) throw new Error('No se pudo crear la Universidad.');
        return { id: Number(js.id) };
    }

    async function createFacultyIfOther(universityId) {
        if ($('cp-fac').value !== '__other__') return { id: Number($('cp-fac').value) || null };
        const name = ($('cp-fac-other').value || '').trim();
        const r = await fetch('/api/academics/faculties', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, university_id: universityId })
        });
        const js = await r.json();
        if (!r.ok || !js.id) throw new Error('No se pudo crear la Facultad.');
        return { id: Number(js.id) };
    }

    async function createCareerIfOther(facultyId) {
        if ($('cp-car').value !== '__other__') return { id: Number($('cp-car').value) || null };
        const name = ($('cp-car-other').value || '').trim();
        const r = await fetch('/api/academics/careers', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, faculty_id: facultyId })
        });
        const js = await r.json();
        if (!r.ok || !js.id) throw new Error('No se pudo crear la Carrera.');
        return { id: Number(js.id) };
    }

    // Eventos
    document.addEventListener('DOMContentLoaded', async () => {
        await loadUniversities();

        $('cp-uni').addEventListener('change', async (e) => {
            toggleOther(e.target, 'cp-uni-other');
            const uniId = e.target.value === '__other__' ? null : Number(e.target.value);
            $('cp-fac-other').style.display = 'none';
            $('cp-car-other').style.display = 'none';
            await loadFaculties(uniId);
            $('cp-car').innerHTML = '<option value="" disabled selected>Elegí tu Carrera</option><option value="__other__">Otra…</option>';
            $('cp-car').disabled = true;
        });

        $('cp-fac').addEventListener('change', async (e) => {
            toggleOther(e.target, 'cp-fac-other');
            const facId = e.target.value === '__other__' ? null : Number(e.target.value);
            $('cp-car-other').style.display = 'none';
            await loadCareers(facId);
        });

        $('cp-car').addEventListener('change', (e) => {
            toggleOther(e.target, 'cp-car-other');
        });

        // Submit con aprendizaje
        $('complete-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validación y carga de hidden (texto final para User)
            const okU = setHiddenFromSelect($('cp-uni'), $('cp-uni-other'), $('cp-hidden-university'));
            const okF = setHiddenFromSelect($('cp-fac'), $('cp-fac-other'), $('cp-hidden-faculty'));
            const okC = setHiddenFromSelect($('cp-car'), $('cp-car-other'), $('cp-hidden-career'));
            if (!okU || !okF || !okC) {
                alert('Completá Universidad, Facultad y Carrera. Si elegís "Otra…", escribí el nombre.');
                return;
            }

            try {
                // Crear lo que sea "Otra…" para que quede guardado en catálogos
                const uni = await createUniversityIfOther();
                const fac = await createFacultyIfOther(uni.id);
                await createCareerIfOther(fac.id);

                // Enviar al backend
                e.target.submit();
            } catch (err) {
                alert(err.message || 'Ocurrió un error guardando tus datos.');
            }
        });
    });
</script>
{% endblock %}