{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:900px;margin:32px auto">
    <h2>{{ 'Actualizar datos acad√©micos' if mode == 'update' else 'Complet√° tu perfil' }}</h2>
    {% if name %}<p class="lead">¬°Hola {{ name }}! Necesitamos estos datos para organizar los apuntes.</p>{% endif %}

    {# üîÅ Acci√≥n correcta seg√∫n el modo #}
    <form action="{{ url_for('update_academics_post') if mode == 'update' else url_for('complete_profile_post') }}"
        method="post" id="complete-profile-form">

        {# El componente de selects dependientes #}
        {% set prefix = 'cp' %}
        {% set names = {'university':'university','faculty':'faculty','career':'career'} %}
        {% include 'components/academics_selects.html' %}

        <button type="submit" class="btn primary">
            {{ 'Guardar cambios' if mode == 'update' else 'Guardar y continuar' }}
        </button>
        <p class="muted" style="margin-top:10px">Podr√°s editar esta informaci√≥n luego desde tu perfil.</p>
    </form>
</div>

<script src="{{ url_for('static', filename='js/academics_selects.js') }}?v=2"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Valores iniciales si estamos en modo actualizaci√≥n
        const initial = {
            university: {{ (current_user.university | tojson) if mode == 'update' else '""'
    }},
        faculty: {{ (current_user.faculty | tojson) if mode == 'update' else '""' }},
    career: { { (current_user.career | tojson) if mode == 'update' else '""' } }
    };

    // Inicializa los selects dependientes
    const api = await window.initAcademicsSelects({
        prefix: 'cp',
        enableCreate: true,
        // Si tu helper soporta initialText, esto los precarga visualmente
        initialText: initial
    });

    // Fallback por si el helper no soporta initialText:
    const hUni = document.getElementById('cp-hidden-university');
    const hFac = document.getElementById('cp-hidden-faculty');
    const hCar = document.getElementById('cp-hidden-career');
    if (hUni && initial.university) hUni.value = initial.university;
    if (hFac && initial.faculty) hFac.value = initial.faculty;
    if (hCar && initial.career) hCar.value = initial.career;

    const form = document.getElementById('complete-profile-form');
    form.addEventListener('submit', async (e) => {
        // Completa los hidden antes de enviar
        try {
            if (api && api.resolveHidden) {
                await api.resolveHidden();
            }
        } catch (err) {
            e.preventDefault();
            alert(err && err.message ? err.message : 'Revis√° los campos seleccionados.');
        }
    });
  });
</script>
{% endblock %}