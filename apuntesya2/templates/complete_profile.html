{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:900px;margin:32px auto">
    <h2>{{ 'Actualizar datos acad√©micos' if mode == 'update' else 'Complet√° tu perfil' }}</h2>
    {% if name %}<p class="lead">¬°Hola {{ name }}! Necesitamos estos datos para organizar los apuntes.</p>{% endif %}

    <!-- üîß Acci√≥n correcta seg√∫n modo -->
    <form action="{{ url_for('update_academics_post') if mode == 'update' else url_for('complete_profile_post') }}"
        method="post" id="complete-profile-form">

        {# Selects dependientes reutilizando el mismo componente #}
        {% set prefix = 'cp' %}
        {% set names = {'university':'university','faculty':'faculty','career':'career'} %}
        {% include 'components/academics_selects.html' %}

        <button type="submit" class="btn primary">
            {{ 'Guardar cambios' if mode == 'update' else 'Guardar y continuar' }}
        </button>
        <p class="muted" style="margin-top:10px">Podr√°s editar esta informaci√≥n luego desde tu perfil.</p>
    </form>
</div>

<script src="{{ url_for('static', filename='js/academics_selects.js') }}?v=2"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Si est√°s actualizando, precargamos textos visibles y hidden
        const initial = {
            university: {{ (current_user.university | tojson) if mode == 'update' else '""'
    }},
        faculty: {{ (current_user.faculty | tojson) if mode == 'update' else '""' }},
    career: { { (current_user.career | tojson) if mode == 'update' else '""' } }
    };

    const api = await window.initAcademicsSelects({
        prefix: 'cp',
        enableCreate: true,
        initialText: initial
    });

    // Fallback para asegurar que los hidden queden con valor en update
    const hU = document.getElementById('cp-hidden-university');
    const hF = document.getElementById('cp-hidden-faculty');
    const hC = document.getElementById('cp-hidden-career');
    if ({{ 'true' if mode == 'update' else 'false' }}) {
        if (hU && initial.university) hU.value = initial.university;
        if (hF && initial.faculty) hF.value = initial.faculty;
        if (hC && initial.career) hC.value = initial.career;
    }

    // Al enviar, resolvemos hidden; solo cancelamos si hay error
    const form = document.getElementById('complete-profile-form');
    form.addEventListener('submit', async (e) => {
        try {
            if (api && api.resolveHidden) { await api.resolveHidden(); }
        } catch (err) {
            e.preventDefault();
            alert(err?.message || 'Revis√° los campos seleccionados.');
        }
    });
  });
</script>
{% endblock %}