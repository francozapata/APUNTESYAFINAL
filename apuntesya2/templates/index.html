{% extends "base.html" %}
{% block content %}

<div class="card mt-3">
  <div class="tabs as-buttons">
    <button class="tab btn ghost {{ 'active' if (show_tab or '') != 'advanced' else '' }}" type="button"
      onclick="toggleTab('quick')">
      Búsqueda rápida
    </button>
    <button class="tab btn ghost {{ 'active' if (show_tab or '') == 'advanced' else '' }}" type="button"
      onclick="toggleTab('advanced')">
      Búsqueda avanzada
    </button>
  </div>

  <!-- -------- BÚSQUEDA RÁPIDA -------- -->
  <div id="tab-quick" class="tab-panel" style="{{ '' if (show_tab or '') != 'advanced' else 'display:none' }}">
    <form id="quick-search" action="{{ url_for('search_quick') }}" method="get" class="search-bar row gap">
      <input class="input flex-1" type="text" name="q" value="{{ q or '' }}"
        placeholder="Buscar por título, descripción o materia..." />
      <button type="submit" class="btn primary">Buscar</button>
    </form>
  </div>

  <!-- -------- BÚSQUEDA AVANZADA -------- -->
  <div id="tab-advanced" class="tab-panel" style="{{ '' if (show_tab or '') == 'advanced' else 'display:none' }}">
    <h2 class="mt-2">Buscar apuntes</h2>

    <form id="advanced-search" action="{{ url_for('search_advanced') }}" method="get" class="stack gap">

      <!-- palabra clave opcional -->
      <div class="field">
        <label>Palabra clave (opcional)</label>
        <input class="input" type="text" name="q" value="{{ q or '' }}" placeholder="Ej: Álgebra, parcial, guía..." />
      </div>

      <!-- Selects académicos (por nombre) -->
      <div class="grid-3 gap">
        <div class="field">
          <label>Universidad</label>
          <select id="acad-uni" class="input">
            <option value="" disabled selected>Elegí tu Universidad</option>
            <option value="__other__">Otra…</option>
          </select>
          <input id="acad-uni-other" class="input" type="text" placeholder="Escribí tu Universidad"
            style="display:none;">
          <input type="hidden" name="university" id="acad-hidden-university" value="{{ (filters.university or '') }}" />
        </div>

        <div class="field">
          <label>Facultad</label>
          <select id="acad-fac" class="input" disabled>
            <option value="" disabled selected>Elegí tu Facultad</option>
            <option value="__other__">Otra…</option>
          </select>
          <input id="acad-fac-other" class="input" type="text" placeholder="Escribí tu Facultad" style="display:none;">
          <input type="hidden" name="faculty" id="acad-hidden-faculty" value="{{ (filters.faculty or '') }}" />
        </div>

        <div class="field">
          <label>Carrera</label>
          <select id="acad-car" class="input" disabled>
            <option value="" disabled selected>Elegí tu Carrera</option>
            <option value="__other__">Otra…</option>
          </select>
          <input id="acad-car-other" class="input" type="text" placeholder="Escribí tu Carrera" style="display:none;">
          <input type="hidden" name="career" id="acad-hidden-career" value="{{ (filters.career or '') }}" />
        </div>
      </div>

      <!-- Tipo (opcional) -->
      <div class="field">
        <label>Tipo</label>
        <select name="type" class="input">
          <option value="" {{ 'selected' if not filters.type }}>Todos</option>
          <option value="free" {{ 'selected' if (filters.type or '' )=='free' }}>Gratis</option>
          <option value="paid" {{ 'selected' if (filters.type or '' )=='paid' }}>Pago</option>
        </select>
      </div>

      <div class="actions mt-2 row gap">
        <button type="submit" class="btn primary" onclick="return beforeSubmitAdvanced()">Aplicar filtros</button>
        <a href="{{ url_for('index') }}" class="btn ghost">Limpiar</a>
      </div>
    </form>
  </div>
</div>

<!-- ===========================
     Resultados (tarjetas)
     =========================== -->
<div class="card mt-3">
  {% if notes and notes|length > 0 %}
  <p class="mt-1">{{ notes|length }} resultado(s)</p>

  <div class="notes-grid">
    {% for n in notes %}
    <article class="note-card card">
      <header class="note-card__header">
        <a href="{{ url_for('note_detail', note_id=n.id) }}" class="note-title link-strong">{{ n.title }}</a>
      </header>

      {% if n.description %}
      <p class="note-card__desc">{{ n.description }}</p>
      {% endif %}

      <div class="note-card__meta">{{ n.university }} • {{ n.faculty }} • {{ n.career }}</div>

      <footer class="note-card__footer">
        <span class="price-tag">
          {% if (n.price_cents or 0) > 0 %}
          ${{ ('%.2f' % (n.price_cents / 100.0)) }}
          {% else %}
          Gratis
          {% endif %}
        </span>
        <a class="btn secondary" href="{{ url_for('note_detail', note_id=n.id) }}">Ver detalle</a>
      </footer>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <p class="muted mt-2">No hay resultados.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
{% if include_dynamic_selects %}
<script src="{{ url_for('static', filename='js/academics_selects.js') }}?v=2"></script>
<script>
  // Tabs
  function toggleTab(which) {
    const quick = document.getElementById('tab-quick');
    const adv = document.getElementById('tab-advanced');
    quick.style.display = which === 'quick' ? '' : 'none';
    adv.style.display = which === 'advanced' ? '' : 'none';

    const tabs = document.querySelectorAll('.tabs.as-buttons .tab');
    tabs.forEach(t => t.classList.remove('active'));
    (which === 'advanced'
      ? document.querySelector('.tabs.as-buttons .tab:nth-child(2)')
      : document.querySelector('.tabs.as-buttons .tab:nth-child(1)')
    ).classList.add('active');
  }

  let selectsApi = null;

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      selectsApi = await window.initAcademicsSelects({
        prefix: 'acad',
        enableCreate: false,
        onChange: ({ level, value }) => {
          const map = { university: 'uni', faculty: 'fac', career: 'car' };
          const sel = document.getElementById('acad-' + map[level]);
          const text = sel && sel.options && sel.selectedIndex >= 0
            ? sel.options[sel.selectedIndex].text
            : '';
          if (level === 'university') document.getElementById('acad-hidden-university').value = value ? text : '';
          if (level === 'faculty') document.getElementById('acad-hidden-faculty').value = value ? text : '';
          if (level === 'career') document.getElementById('acad-hidden-career').value = value ? text : '';
        }
      });
    } catch (e) {
      console.error('init selects error', e);
    }
  });

  async function beforeSubmitAdvanced() {
    try {
      if (selectsApi && selectsApi.resolveHidden) {
        await selectsApi.resolveHidden();
      }
      return true;
    } catch (e) {
      alert(e.message || e);
      return false;
    }
  }
</script>
{% endif %}
{% endblock %}