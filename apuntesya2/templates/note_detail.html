{% extends "base.html" %}
{% block content %}

<style>
  .note-shell {
    max-width: 980px;
    margin: 32px auto;
  }

  .note-card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7f5;
    padding: 22px 20px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
  }

  .note-header {
    margin-bottom: 16px;
  }

  .note-title {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #111827;
  }

  .note-meta-top {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 13px;
    color: #6b7280;
  }

  .note-meta-top span+span::before {
    content: "‚Ä¢";
    margin: 0 4px;
    color: #9ca3af;
  }

  .rating-summary {
    margin-top: 8px;
    font-size: 14px;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .rating-summary strong {
    font-weight: 700;
  }

  .rating-pill {
    padding: 2px 10px;
    border-radius: 999px;
    background: #f7f9ff;
    border: 1px solid #e0e4ff;
    font-size: 12px;
    color: #4b5563;
  }

  .muted {
    color: #666;
    font-size: 14px;
  }

  .note-layout {
    margin-top: 12px;
    display: grid;
    grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
    gap: 24px;
  }

  .note-main {
    min-width: 0;
  }

  .note-description {
    font-size: 14px;
    color: #111827;
    line-height: 1.5;
  }

  .note-meta-detail {
    margin-top: 10px;
    font-size: 13px;
    color: #6b7280;
  }

  .note-meta-detail span+span::before {
    content: "‚Ä¢";
    margin: 0 4px;
    color: #9ca3af;
  }

  .note-side {
    min-width: 0;
  }

  .note-side-box {
    border-radius: 14px;
    border: 1px solid #eeeeff;
    background: #fafbff;
    padding: 14px 14px 12px;
  }

  .note-price-label {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 2px;
  }

  .note-price-value {
    font-size: 22px;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .note-price-free {
    font-size: 18px;
    font-weight: 700;
    color: #166534;
  }

  .note-cta {
    margin-top: 12px;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 18px;
    background: #4478ff;
    color: #fff;
    border-radius: 999px;
    border: none;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.1s ease;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(68, 120, 255, 0.35);
  }

  .btn-primary.ghost {
    background: #f3f6ff;
    color: #335;
    box-shadow: none;
  }

  .note-help-text {
    margin-top: 8px;
    font-size: 12px;
    color: #6b7280;
  }

  .note-contact {
    margin-top: 12px;
    font-size: 13px;
  }

  .note-contact a {
    color: #4460ff;
    font-weight: 500;
    text-decoration: underline;
    text-decoration-thickness: 1px;
  }

  .note-side-small {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px dashed #d4d8ff;
    font-size: 12px;
    color: #6b7280;
  }

  /* Rese√±as */
  .review-block {
    border-top: 1px solid #e5e7f0;
    margin-top: 24px;
    padding-top: 18px;
  }

  .review-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .review-header-row h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #111827;
  }

  .review-header-row span {
    font-size: 12px;
    color: #9ca3af;
  }

  .review-form {
    margin-bottom: 18px;
    padding: 10px 12px;
    border-radius: 12px;
    background: #f7f9ff;
    border: 1px solid #e0e4ff;
  }

  .review-form label {
    font-size: 13px;
  }

  select.review-rating {
    padding: 6px 8px;
    border-radius: 10px;
    border: 1px solid #d9d9e3;
    font-size: 13px;
    margin-top: 4px;
  }

  textarea.review-text {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #d9d9e3;
    padding: 8px 10px;
    resize: vertical;
    min-height: 70px;
    font-size: 13px;
    margin-top: 4px;
  }

  .review-item {
    border-bottom: 1px solid #f3f3f7;
    padding: 10px 0;
  }

  .review-item:last-child {
    border-bottom: none;
  }

  .review-stars {
    color: #ffb400;
    font-size: 15px;
    margin-bottom: 2px;
  }

  .review-author {
    margin: 0;
    font-weight: 600;
    font-size: 13px;
    color: #111827;
  }

  .review-comment {
    margin: 3px 0 4px;
    font-size: 13px;
  }

  .review-date {
    font-size: 12px;
    margin: 0;
    color: #9ca3af;
  }

  @media (max-width: 880px) {
    .note-card {
      padding: 20px 16px;
    }

    .note-layout {
      grid-template-columns: minmax(0, 1fr);
    }

    .note-side {
      order: -1;
    }
  }
</style>

<div class="note-shell">
  <div class="note-card">
    <!-- HEADER -->
    <div class="note-header">
      <h2 class="note-title">{{ note.title }}</h2>

      <div class="note-meta-top">
        <span>{{ note.university }}</span>
        <span>{{ note.faculty }}</span>
        <span>{{ note.career }}</span>
      </div>

      {% if avg_rating and reviews %}
      <div class="rating-summary">
        <span>‚≠ê <strong>{{ avg_rating }}</strong>/5</span>
        <span class="rating-pill">
          {{ reviews|length }} rese√±a{{ '' if reviews|length == 1 else 's' }}
        </span>
      </div>
      {% else %}
      <p class="muted" style="margin-top: 8px;">
        Este apunte todav√≠a no tiene rese√±as.
      </p>
      {% endif %}
    </div>

    <!-- LAYOUT DOS COLUMNAS -->
    <div class="note-layout">
      <!-- COLUMNA IZQUIERDA: descripci√≥n y detalle -->
      <div class="note-main">
        {% if note.description %}
        <p class="note-description">
          {{ note.description }}
        </p>
        {% else %}
        <p class="muted">
          El autor no agreg√≥ una descripci√≥n detallada para este apunte.
        </p>
        {% endif %}

        {# ---------- PREVIEW (watermarked) ---------- #}
        {% if note.preview_images and note.preview_images.images %}
        <div style="margin:14px 0 6px;">
          <div class="muted" style="margin-bottom:8px;">
            Vista previa (marca de agua ApuntesYa). No descargable.
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
            {% for _img in note.preview_images.images %}
              <div style="border:1px solid #e5e7f5;border-radius:12px;overflow:hidden;background:#fff;">
                <img
                  src="{{ url_for('note_preview_image', note_id=note.id, idx=loop.index) }}"
                  alt="Vista previa {{ loop.index }}"
                  style="width:100%;height:auto;display:block;user-select:none;"
                  draggable="false"
                />
              </div>
            {% endfor %}
          </div>
        </div>
        <script>
          // Soft anti-copy protections (not bulletproof)
          document.addEventListener('contextmenu', function(e){
            if(e.target && e.target.tagName === 'IMG'){ e.preventDefault(); }
          });
        </script>
        {% endif %}

        <div class="note-meta-detail">
          <span>Formato: PDF</span>
          <span>Descargas: {{ note.download_count or 0 }}</span>
        </div>

        {# Bloque de rese√±as #}
        <div class="review-block" id="reviews">
          <div class="review-header-row">
            <h3>Rese√±as</h3>
            {% if reviews %}
            <span>
              {{ reviews|length }} comentario{{ '' if reviews|length == 1 else 's' }}
            </span>
            {% endif %}
          </div>

          {% if can_review %}
          <form method="post" action="{{ url_for('submit_review', note_id=note.id) }}" class="review-form">
            <label class="muted">Tu calificaci√≥n:</label><br>
            <select name="rating" required class="review-rating">
              <option value="">Elegir‚Ä¶</option>
              <option value="5">5 ‚≠ê</option>
              <option value="4">4 ‚≠ê</option>
              <option value="3">3 ‚≠ê</option>
              <option value="2">2 ‚≠ê</option>
              <option value="1">1 ‚≠ê</option>
            </select>

            <label class="muted" style="margin-top:8px;display:block;">
              Comentario (opcional):
            </label>
            <textarea name="comment" class="review-text"
              placeholder="Cont√° brevemente qu√© te pareci√≥ el apunte‚Ä¶"></textarea>

            <button type="submit" class="btn-primary" style="margin-top:8px;">
              Enviar rese√±a
            </button>
          </form>
          {% elif already_reviewed %}
          <p class="muted" style="margin-bottom:10px;">
            Ya enviaste una rese√±a para este apunte ‚úÖ
          </p>
          {% endif %}

          {% if reviews %}
          {% for r, buyer_name in reviews %}
          <div class="review-item">
            <div class="review-stars">
              {% for i in range(r.rating) %}‚≠ê{% endfor %}
            </div>
            <p class="review-author">{{ buyer_name }}</p>
            {% if r.comment %}
            <p class="review-comment">{{ r.comment }}</p>
            {% endif %}
            <p class="review-date">
              {{ r.created_at.strftime('%d/%m/%Y') }}
            </p>
          </div>
          {% endfor %}
          {% else %}
          <p class="muted" style="margin-top:4px;">
            Todav√≠a no hay rese√±as. S√© el primero en opinar üôå
          </p>
          {% endif %}
        </div>
      </div>

      <!-- COLUMNA DERECHA: precio, acci√≥n y contacto -->
      <div class="note-side">
        <div class="note-side-box">
          {# ---------- PRECIO ---------- #}
          {% set net_cents = (note.seller_net_cents or note.price_cents or 0) %}
          {% if net_cents == 0 %}
          <p class="note-price-label">Precio</p>
          <p class="note-price-free">Gratis</p>
          {% else %}
          <p class="note-price-label">Precio para comprar este apunte</p>
          <p class="note-price-value">
            ${{ '%.1f' % published_price(net_cents) }}
          </p>
          {% endif %}

          {# ---------- ACCI√ìN PRINCIPAL: COMPRAR / DESCARGAR ---------- #}
          <div class="note-cta">
            {% if can_download %}
            <a href="{{ url_for('download_note', note_id=note.id) }}" class="btn-primary">
              Descargar PDF
            </a>
            <p class="note-help-text">
              Ya ten√©s acceso a este apunte. Si no se abre autom√°ticamente, pod√©s descargarlo desde este bot√≥n.
            </p>
            {% elif net_cents > 0 %}
            <a href="{{ url_for('buy_note', note_id=note.id) }}" class="btn-primary">
              Comprar apunte
            </a>
            <p class="note-help-text">
              Una vez completado el pago, vas a poder descargar el PDF desde esta misma p√°gina y desde tu perfil.
            </p>
            {% else %}
            {# Apunte gratis pero sin permiso de descarga (caso raro) #}
            <p class="note-help-text">
              Inici√° sesi√≥n para poder descargar este apunte gratuito.
            </p>
            {% endif %}
          </div>

          {# ---------- VENDEDOR + CONTACTO ---------- #}
          {% if seller %}
          <div class="note-contact">
            <div style="display:flex;align-items:center;gap:10px;margin:0 0 8px;">
              {% if seller.imagen_de_perfil %}
                <img src="{{ url_for('user_avatar', user_id=seller.id) }}" alt="Foto de perfil" style="width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid #eef;background:#f4f4ff;" />
              {% else %}
                <div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#4b5563;background:#f4f4ff;border:2px solid #eef;">{{ (seller.name or seller.email)[0:1].upper() }}</div>
              {% endif %}

              <p class="muted" style="margin:0;">
                Vendedor:
                <a href="{{ url_for('seller_profile', seller_id=seller.id) }}">{{ seller.name }}</a>
              {% if seller_verified %}
                <span class="rating-pill" title="Vendedor verificado">Verificado</span>
              {% endif %}
              </p>
            </div>
            {% if seller_contacts and (can_download or note.price_cents==0) %}
              <p class="muted" style="margin:0 0 4px;">Contacto del vendedor:</p>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                {% for url, label in seller_contacts %}
                  <a class="rating-pill" href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ label }}</a>
                {% endfor %}
              </div>
            {% else %}
              <p class="note-help-text" style="margin-top:6px;">Tras la compra vas a ver los datos de contacto del vendedor ac√° mismo.</p>
            {% endif %}
          </div>
          {% endif %}

          <div class="note-side-small">
            Solo los usuarios registrados pueden comprar y dejar rese√±as sobre los apuntes.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if paid and can_download %}
<script>
  (function () {
    // Dispara la descarga del PDF en segundo plano,
    // pero la p√°gina visible sigue siendo el detalle del apunte.
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = "{{ url_for('download_note', note_id=note.id) }}";
    document.body.appendChild(iframe);
  })();
</script>
{% endif %}

{% endblock %}