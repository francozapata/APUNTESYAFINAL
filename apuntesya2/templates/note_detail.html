{% extends "base.html" %}
{% block content %}

<style>
  .note-card {
    max-width: 900px;
    margin: 32px auto;
    background: #fff;
    border-radius: 14px;
    border: 1px solid #eee;
    padding: 24px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
  }

  .muted {
    color: #666;
    font-size: 14px;
  }

  .btn-primary {
    display: inline-block;
    padding: 10px 18px;
    background: #4478ff;
    color: #fff;
    border-radius: 10px;
    border: none;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-pill {
    padding: 8px 14px;
    border-radius: 999px;
    background: #4478ff;
    color: #fff;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
  }

  .review-block {
    border-top: 1px solid #eee;
    margin-top: 20px;
    padding-top: 20px;
  }

  .review-item {
    border-bottom: 1px solid #f0f0f0;
    padding: 12px 0;
  }

  .review-stars {
    color: #ffb400;
    font-size: 16px;
    margin-bottom: 4px;
  }

  .note-meta {
    color: #555;
    font-size: 14px;
  }
</style>


<div class="note-card">

  <h2>{{ note.title }}</h2>

  {% if not reviews %}
  <p class="muted">
    Este apunte todavía no tiene reseñas.
  </p>
  {% endif %}

  <p>{{ note.description }}</p>

  <p class="note-meta">
    {{ note.university }} • {{ note.faculty }} • {{ note.career }}
  </p>

  <!-- ============================
       PRECIO (con comisiones)
  ============================= -->
  {% if note.price_cents == 0 %}
  <p><strong>Precio:</strong> Gratis</p>
  {% else %}
  <p>
    <strong>Precio:</strong>
    ${{ '%.2f' % buyer_price }}
    <span class="muted" style="font-size:13px;">
      (el vendedor recibe ${{ '%.2f' % base_price }})
    </span>
  </p>
  {% endif %}

  <!-- ============================
       ACCIONES: comprar o descargar
  ============================= -->
  {% if can_download %}
  <a href="{{ url_for('download_note', note_id=note.id) }}" class="btn-primary">
    Descargar PDF
  </a>
  {% elif note.price_cents > 0 %}
  <a href="{{ url_for('buy_note', note_id=note.id) }}" class="btn-primary">
    Comprar
  </a>
  {% endif %}

  <!-- ============================
       CONTACTO DEL VENDEDOR
  ============================= -->
  {% if seller_contact_url %}
  <p class="muted" style="margin-top:16px;">
    Contactar vendedor:
    <a href="{{ seller_contact_url }}" target="_blank">
      {{ seller_contact_label }}
    </a>
  </p>
  {% endif %}

  <!-- ============================
       RESEÑAS
  ============================= -->
  <div class="review-block">
    <h3>Reseñas</h3>

    {% if avg_rating %}
    <p>
      ⭐ <strong>{{ avg_rating }}</strong>/5
      <span class="muted">({{ reviews|length }} reseñas)</span>
    </p>
    {% endif %}

    {% if can_review %}
    <form method="post" action="{{ url_for('review_note', note_id=note.id) }}" style="margin-bottom:16px;">

      <label class="muted">Tu calificación:</label>
      <select name="rating" required style="padding:6px;border-radius:8px;border:1px solid #ccc;">
        <option value="">Elegir…</option>
        <option value="5">5 ⭐</option>
        <option value="4">4 ⭐</option>
        <option value="3">3 ⭐</option>
        <option value="2">2 ⭐</option>
        <option value="1">1 ⭐</option>
      </select>

      <textarea name="comment" placeholder="Escribí tu reseña…" rows="3"
        style="width:100%;margin-top:8px;padding:10px;border-radius:10px;border:1px solid #ccc;"></textarea>

      <button class="btn-primary" style="margin-top:8px;">
        Enviar reseña
      </button>
    </form>
    {% endif %}

    {% if reviews %}
    {% for r, buyer_name in reviews %}
    <div class="review-item">
      <div class="review-stars">
        {% for i in range(r.rating) %}⭐{% endfor %}
      </div>
      <p style="margin:0;"><strong>{{ buyer_name }}</strong></p>
      {% if r.comment %}
      <p style="margin:4px 0;">{{ r.comment }}</p>
      {% endif %}
      <p class="muted" style="font-size:12px;margin:0;">
        {{ r.created_at.strftime('%d/%m/%Y') }}
      </p>
    </div>
    {% endfor %}
    {% endif %}
  </div>
</div>

{% endblock %}