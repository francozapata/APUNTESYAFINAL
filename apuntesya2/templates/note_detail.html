{% extends "base.html" %}
{% block content %}
<div class="card">
  {% if current_user.is_authenticated and current_user.id == note.seller_id and not current_user.mp_access_token %}
  <div class="card" style="background:#161a22;border-color:#2a3446;margin-bottom:12px;">
    Para vender este apunte y cobrar directo, conectá tu cuenta de Mercado Pago desde tu <a
      href='{{ url_for("profile") }}'>perfil</a>.
  </div>
  {% endif %}
  <h2>{{ note.title }}</h2>
  {% if avg_rating %}
  <p><strong>Calificación promedio:</strong>
    {% for i in range(1,6) %}
    {% if i <= avg_rating|round(0, 'floor' ) %}★{% else %}☆{% endif %} {% endfor %} ({{ avg_rating }}) </p>
      {% else %}
      <p><em>Este apunte todavía no tiene reseñas.</em></p>
      {% endif %}

      <p>{{ note.description }}</p>
      <p class="muted">{{ note.university }} • {{ note.faculty }} • {{ note.career }}</p>
      {% if note.price_cents and note.price_cents>0 %}
      <p><strong>Precio:</strong> ${{ '%.2f'|format(note.price_cents/100) }}</p>
      {% if can_download %}
      <a class="btn" href="{{ url_for('download_note', note_id=note.id) }}">Descargar PDF</a>
      {% else %}
      <a class="btn" href="{{ url_for('buy_note', note_id=note.id) }}">Comprar</a>
      <a class="btn secondary" href="{{ url_for('mp_return', note_id=note.id) }}">Verificar pago</a>
      {% endif %}
      {% else %}
      <a class="btn" href="{{ url_for('download_note', note_id=note.id) }}">Descargar gratis</a>
      {% endif %}
      {% if can_review %}
      <hr>
      <h3>Dejar una reseña</h3>
      <form action="{{ url_for('submit_review', note_id=note.id) }}" method="post">
        <label>Puntuación:</label>
        <select name="rating" required>
          <option value="" disabled selected>Elegí…</option>
          <option value="5">★★★★★ (5)</option>
          <option value="4">★★★★ (4)</option>
          <option value="3">★★★ (3)</option>
          <option value="2">★★ (2)</option>
          <option value="1">★ (1)</option>
        </select>
        <br>
        <label>Comentario (opcional):</label><br>
        <textarea name="comment" rows="3" style="width:100%;" placeholder="¿Qué te pareció el apunte?"></textarea>
        <br>
        <button type="submit">Enviar reseña</button>
      </form>
      {% elif already_reviewed %}
      <p><em>Ya enviaste una reseña para este apunte.</em></p>
      {% endif %}
      {% if reviews and reviews|length > 0 %}
      <hr>
      <h3>Reseñas</h3>
      <ul>
        {% for r, buyer_name in reviews %}
        <li style="margin-bottom: 10px;">
          <strong>{{ buyer_name }}</strong> —
          {% for i in range(1,6) %}
          {% if i <= r.rating %}★{% else %}☆{% endif %} {% endfor %} <br>
            {% if r.comment %}<span>{{ r.comment }}</span><br>{% endif %}
            <small>{{ r.created_at.strftime("%Y-%m-%d %H:%M") }}</small>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
</div>
{% endblock %}