{% extends "base.html" %}
{% block content %}

<style>
  .note-card {
    max-width: 900px;
    margin: 32px auto;
    background: #fff;
    border-radius: 14px;
    border: 1px solid #eee;
    padding: 24px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
  }

  .muted {
    color: #666;
    font-size: 14px;
  }

  .btn-primary {
    display: inline-block;
    padding: 10px 18px;
    background: #4478ff;
    color: #fff;
    border-radius: 12px;
    border: none;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-primary.ghost {
    background: #f3f6ff;
    color: #335;
  }

  .note-meta {
    color: #555;
    font-size: 14px;
    margin-top: 4px;
  }

  .review-block {
    border-top: 1px solid #eee;
    margin-top: 24px;
    padding-top: 18px;
  }

  .review-item {
    border-bottom: 1px solid #f3f3f3;
    padding: 10px 0;
  }

  .review-stars {
    color: #ffb400;
    font-size: 15px;
    margin-bottom: 2px;
  }

  textarea.review-text {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #d9d9e3;
    padding: 8px 10px;
    resize: vertical;
    min-height: 70px;
  }

  select.review-rating {
    padding: 6px 8px;
    border-radius: 10px;
    border: 1px solid #d9d9e3;
  }
</style>

<div class="note-card">
  <h2 style="margin-top:0;">{{ note.title }}</h2>

  {% if not reviews %}
  <p class="muted">
    Este apunte todav√≠a no tiene rese√±as.
  </p>
  {% else %}
  {% if avg_rating %}
  <p class="muted" style="margin:4px 0 10px;">
    ‚≠ê <strong>{{ avg_rating }}</strong>/5 &nbsp;
    ({{ reviews|length }} rese√±as)
  </p>
  {% endif %}
  {% endif %}

  {% if note.description %}
  <p>{{ note.description }}</p>
  {% endif %}

  <p class="note-meta">
    {{ note.university }} ‚Ä¢ {{ note.faculty }} ‚Ä¢ {{ note.career }}
  </p>

  {# ---------- PRECIO ---------- #}
  {% if note.price_cents == 0 %}
  <p style="margin-top:12px;">
    <strong>Precio:</strong> Gratis
  </p>
  {% else %}
  <p style="margin-top:12px;">
    <strong>Precio:</strong>
    ${{ '%.2f' % buyer_price }}
  </p>
  {% endif %}

  {# ---------- ACCI√ìN PRINCIPAL: COMPRAR / DESCARGAR ---------- #}
  <div style="margin-top:12px;">
    {% if can_download %}
    <a href="{{ url_for('download_note', note_id=note.id) }}" class="btn-primary">
      Descargar PDF
    </a>
    {% elif note.price_cents > 0 %}
    <a href="{{ url_for('buy_note', note_id=note.id) }}" class="btn-primary">
      Comprar
    </a>
    {% endif %}
  </div>

  {# ---------- CONTACTO DEL VENDEDOR ---------- #}
  {% if seller_contact_url %}
  <p class="muted" style="margin-top:14px;">
    ¬øTen√©s dudas sobre el apunte?
    <a href="{{ seller_contact_url }}" target="_blank">
      {{ seller_contact_label }}
    </a>
  </p>
  {% endif %}

  {# ---------- RESE√ëAS ---------- #}
  <div class="review-block" id="reviews">
    <h3 style="margin-top:0;">Rese√±as</h3>

    {% if can_review %}
    <form method="post" action="{{ url_for('submit_review', note_id=note.id) }}" style="margin-bottom:18px;">

      <label class="muted">Tu calificaci√≥n:</label><br>
      <select name="rating" required class="review-rating">
        <option value="">Elegir‚Ä¶</option>
        <option value="5">5 ‚≠ê</option>
        <option value="4">4 ‚≠ê</option>
        <option value="3">3 ‚≠ê</option>
        <option value="2">2 ‚≠ê</option>
        <option value="1">1 ‚≠ê</option>
      </select>

      <br>
      <label class="muted" style="margin-top:8px;display:block;">
        Comentario (opcional):
      </label>
      <textarea name="comment" class="review-text" placeholder="Cont√° brevemente qu√© te pareci√≥ el apunte‚Ä¶"></textarea>

      <button type="submit" class="btn-primary" style="margin-top:8px;">
        Enviar rese√±a
      </button>
    </form>
    {% elif already_reviewed %}
    <p class="muted" style="margin-bottom:10px;">
      Ya enviaste una rese√±a para este apunte ‚úÖ
    </p>
    {% endif %}

    {% if reviews %}
    {% for r, buyer_name in reviews %}
    <div class="review-item">
      <div class="review-stars">
        {% for i in range(r.rating) %}‚≠ê{% endfor %}
      </div>
      <p style="margin:0;font-weight:600;">{{ buyer_name }}</p>
      {% if r.comment %}
      <p style="margin:3px 0 4px;">{{ r.comment }}</p>
      {% endif %}
      <p class="muted" style="font-size:12px;margin:0;">
        {{ r.created_at.strftime('%d/%m/%Y') }}
      </p>
    </div>
    {% endfor %}
    {% else %}
    <p class="muted" style="margin-top:4px;">
      Todav√≠a no hay rese√±as. S√© el primero en opinar üôå
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}