{% extends "base.html" %}
{% block content %}

<style>
  .upload-shell {
    max-width: 980px;
    margin: 32px auto;
  }

  .upload-card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7f5;
    padding: 22px 20px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
  }

  .upload-header {
    margin-bottom: 16px;
  }

  .upload-header h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #111827;
  }

  .upload-header p {
    margin: 6px 0 0;
    font-size: 13px;
    color: #6b7280;
  }

  .upload-grid {
    margin-top: 10px;
    display: grid;
    grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
    gap: 24px;
  }

  .upload-main,
  .upload-side {
    min-width: 0;
  }

  .upload-form-group {
    margin-bottom: 12px;
  }

  .upload-form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
  }

  .upload-form-group .input {
    width: 100%;
  }

  .upload-hint {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
  }

  .upload-side-box {
    border-radius: 14px;
    border: 1px solid #eeeeff;
    background: #fafbff;
    padding: 14px 14px 12px;
    margin-bottom: 12px;
  }

  .upload-side-box h2,
  .upload-side-box h3 {
    margin: 0 0 8px;
    font-size: 15px;
    font-weight: 600;
    color: #111827;
  }

  .upload-side-box p {
    margin: 0 0 8px;
    font-size: 13px;
    color: #4b5563;
  }

  .explicacion-titulo {
    font-size: 15px;
    margin: 0 0 6px;
  }

  .explicacion-intro {
    margin: 0 0 8px;
    font-size: 13px;
  }

  .pasos-calculo {
    padding-left: 18px;
    margin: 0 0 10px;
    font-size: 13px;
  }

  .paso-item {
    margin-bottom: 6px;
  }

  .desglose-comision {
    margin: 4px 0 0;
    padding-left: 16px;
    font-size: 12px;
  }

  .disclaimer-iibb {
    margin-top: 8px;
    padding: 8px 10px;
    border-radius: 10px;
    background: #fef3c7;
    border: 1px solid #fde68a;
  }

  .disclaimer-titulo {
    margin: 0 0 4px;
    font-size: 13px;
    font-weight: 600;
    color: #92400e;
  }

  .disclaimer-texto {
    margin: 0;
    font-size: 12px;
    color: #78350f;
  }

  .upload-resumen-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 4px;
    font-size: 13px;
  }

  .upload-resumen-grid div strong {
    font-weight: 600;
  }

  .mt-2 {
    margin-top: 0.5rem;
  }

  .mt-3 {
    margin-top: 0.75rem;
  }

  .mt-4 {
    margin-top: 1rem;
  }

  .text-sm {
    font-size: 0.875rem;
  }

  .inline-flex {
    display: inline-flex;
  }

  .items-center {
    align-items: center;
  }

  .ml-2 {
    margin-left: 0.5rem;
  }

  .text-blue-600 {
    color: #2563eb;
  }

  .text-blue-600:hover {
    text-decoration: underline;
  }

  .btn-submit {
    margin-top: 16px;
  }

  .btn-submit .btn {
    border-radius: 999px;
    padding: 8px 18px;
    font-weight: 600;
  }

  @media (max-width: 880px) {
    .upload-card {
      padding: 20px 16px;
    }

    .upload-grid {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>

<div class="upload-shell">
  <div class="upload-card">
    <div class="upload-header">
      <h2>Subir apunte (PDF)</h2>
      <p>
        Complet√° los datos del apunte, defin√≠ cu√°nto quer√©s recibir y carg√° el archivo PDF.
        Nosotros nos encargamos del resto üí∏üìö
      </p>
    </div>

    <form method="post" enctype="multipart/form-data" id="uploadForm">
      <div class="upload-grid">
        <!-- COLUMNA IZQUIERDA: campos principales -->
        <div class="upload-main">
          <div class="upload-form-group">
            <label for="title">T√≠tulo</label>
            <input class="input" name="title" id="title" required>
          </div>

          <div class="upload-form-group">
            <label for="description">Descripci√≥n</label>
            <input class="input" name="description" id="description" required>
            <p class="upload-hint">
              Pod√©s indicar temas incluidos, a√±o de cursado, docente, tipo de examen, etc.
            </p>
          </div>

          {% set prefix = 'up' %}
          {% set names = {'university':'university','faculty':'faculty','career':'career'} %}
          {% include 'components/academics_selects.html' %}

          <div class="upload-form-group" style="margin-top:14px;">
            <label for="price">
              Precio (ARS)
            </label>
            <input class="input" name="price" id="price" type="number" min="0" step="0.01">
            <p class="upload-hint">
              Este es el monto que quer√©s recibir por cada venta. Si lo dej√°s en blanco o 0, el apunte ser√° gratis.
            </p>
          </div>

          <div class="upload-form-group" style="margin-top:14px;">
            <label for="file">Archivo PDF</label>
            <input class="input" type="file" name="file" id="file" accept="application/pdf" required>
            <p class="upload-hint">
              Formato recomendado: PDF legible, sin fotos borrosas. Peso m√°ximo seg√∫n las condiciones de la plataforma.
            </p>
          </div>

          <div class="mt-3">
            <label class="inline-flex items-center">
              <input type="checkbox" name="accept_commissions" required>
              <span class="ml-2 text-sm">
                Declaro haber le√≠do y aceptado las comisiones y plazos de acreditaci√≥n indicados.
                <a href="{{ url_for('help_commissions') }}" class="text-blue-600">Ver detalle</a>
              </span>
            </label>
          </div>

          <div class="btn-submit">
            <button class="btn">Subir apunte</button>
          </div>
        </div>

        <!-- COLUMNA DERECHA: explicaci√≥n y resumen -->
        <div class="upload-side">
          <div class="upload-side-box">
            <h2 class="explicacion-titulo">üí° C√≥mo calculamos tu ganancia</h2>
            <p class="explicacion-intro">
              En ApuntesYa, vos decid√≠s el precio que quer√©s recibir y nosotros
              sumamos las comisiones al precio final que ve el comprador.
            </p>

            <ol class="pasos-calculo">
              <li class="paso-item">
                <strong>Defin√≠s tu ganancia (Precio Base):</strong>
                ingres√°s el monto que quer√©s recibir por la venta de tu apunte.
              </li>
              <li class="paso-item">
                <strong>Sumamos la comisi√≥n total (20%):</strong>
                agregamos una Comisi√≥n Total del 20% al precio de venta que ver√° el comprador:
                <ul class="desglose-comision">
                  <li><strong>8%</strong> (aprox.) para <strong>Mercado Pago</strong> (procesamiento de pago).</li>
                  <li><strong>12%</strong> para <strong>ApuntesYa</strong> (mantenimiento y mejora de la plataforma).
                  </li>
                </ul>
              </li>
              <li class="paso-item">
                <strong>Recib√≠s lo que pediste:</strong>
                cuando se vende el apunte, recib√≠s tu <strong>Precio Base</strong> completo,
                antes de la retenci√≥n de IIBB.
              </li>
            </ol>

            <aside class="disclaimer-iibb">
              <h3 class="disclaimer-titulo">‚ö†Ô∏è Nota importante sobre impuestos</h3>
              <p class="disclaimer-texto">
                Tu <strong>Precio Base</strong> est√° sujeto a la
                retenci√≥n de <strong>Ingresos Brutos (IIBB)</strong>, un impuesto provincial obligatorio.
                Esta deducci√≥n la aplica directamente el procesador de pagos y puede variar seg√∫n tu situaci√≥n fiscal.
                Te recomendamos consultarlo con tu contador.
              </p>
            </aside>

            <p class="mt-2 text-sm">
              ¬øDudas con Mercado Pago?
              <a href="{{ url_for('help_mp') }}" class="text-blue-600">Ver instructivo</a>.
            </p>
          </div>

          <div class="upload-side-box" id="resumen-publicacion">
            <h3>Resumen de publicaci√≥n</h3>
            <p class="text-sm">
              Este c√°lculo es estimativo. Tomamos como base el precio que cargues arriba
              (lo que vos quer√©s recibir) y calculamos cu√°nto se suma en comisiones
              (<strong>8% Mercado Pago</strong> + <strong>12% plataforma ApuntesYa</strong>) y
              cu√°l ser√≠a el total aproximado que paga la persona que compra.
            </p>

            <div class="upload-resumen-grid">
              <div><strong>Lo que quer√©s recibir (X):</strong> $<span id="rp-precio">0.00</span></div>
              <div><strong>Comisi√≥n Mercado Pago (8%):</strong> $<span id="rp-mp">0.00</span></div>
              <div><strong>Comisi√≥n ApuntesYa (12%):</strong> $<span id="rp-ay">0.00</span></div>
              <div><strong>Neto estimado para vos:</strong> $<span id="rp-neto">0.00</span></div>
              <div><strong>Total estimado que paga el comprador:</strong> $<span id="rp-buyer">0.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='js/academics_selects.js') }}?v=1"></script>
<script>
  // Inicializa selects din√°micos de universidad / facultad / carrera
  document.addEventListener('DOMContentLoaded', async () => {
    const api = await window.initAcademicsSelects({ prefix: 'up', enableCreate: true });
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await api.resolveHidden();
      } catch (err) {
        alert(err.message);
        return;
      }
      form.submit();
    });
  });
</script>

<script>
  // C√°lculo din√°mico de comisiones y total para el comprador
  (function () {
    var box = document.getElementById('resumen-publicacion');
    if (!box) return;

    var precioInput = document.getElementById('price');

    function toNum(v) {
      var x = parseFloat((v || '').replace(',', '.'));
      return isNaN(x) ? 0 : x;
    }

    var ayPct = 12.0; // plataforma
    var mpPct = 8.0;  // MP
    var totalPct = ayPct + mpPct; // 20%

    function fmt(n) { return n.toFixed(2); }

    function recalc() {
      if (!precioInput) return;
      var x = toNum(precioInput.value);  // X = lo que vos quer√©s recibir

      var feeMP = x * (mpPct / 100);
      var feeAY = x * (ayPct / 100);
      var totalBuyer = x * (1 + totalPct / 100);
      var netoVendedor = x;  // X es lo que recib√≠s

      var $ = function (id) { return document.getElementById(id); };

      if ($('rp-precio')) $('rp-precio').textContent = fmt(x);
      if ($('rp-mp')) $('rp-mp').textContent = fmt(feeMP);
      if ($('rp-ay')) $('rp-ay').textContent = fmt(feeAY);
      if ($('rp-neto')) $('rp-neto').textContent = fmt(netoVendedor);
      if ($('rp-buyer')) $('rp-buyer').textContent = fmt(totalBuyer);
    }

    if (precioInput) {
      precioInput.addEventListener('input', recalc);
      recalc();
    }
  })();
</script>

{% endblock %}