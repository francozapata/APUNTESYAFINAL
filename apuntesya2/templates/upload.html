{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:1200px;margin:32px auto">
  <h2>Subir apunte (PDF)</h2>
  <form method="post" enctype="multipart/form-data" id="uploadForm">
    <label>T√≠tulo</label><input class="input" name="title" required>
    <label>Descripci√≥n</label><input class="input" name="description" required>

    {% set prefix = 'up' %}
    {% set names = {'university':'university','faculty':'faculty','career':'career'} %}
    {% include 'components/academics_selects.html' %}

    <label style="margin-top:14px">Precio (ARS). Dejar en blanco para gratis</label>
    <input class="input" name="price" id="price" id="price" type="number" min="0" step="0.01">

    <div class="card" style="margin-top:16px">
      <h2 class="explicacion-titulo">üí° C√≥mo Calculamos tu Ganancia</h2>

      <p class="explicacion-intro">En ApuntesYa, t√∫ decides el precio que quieres recibir, y nosotros nos encargamos de
        agregar las comisiones al precio final del comprador.</p>

      <ol class="pasos-calculo">
        <li class="paso-item">
          <strong>1. Fijas tu Ganancia (Precio Base):</strong> Ingresas el monto que deseas recibir por la venta de tu
          apunte.
        </li>
        <li class="paso-item">
          <strong>2. Agregamos la Comisi√≥n Total (20%):</strong> Sumamos una Comisi√≥n Total del 20% al precio de venta
          que
          ver√° el comprador.
          <ul class="desglose-comision">
            <li><strong>8%</strong> (aprox.) va para <strong>Mercado Pago</strong> (costo de procesamiento).</li>
            <li><strong>12%</strong> va para <strong>ApuntesYa</strong> (nuestra ganancia por la plataforma).</li>
          </ul>
        </li>
        <li class="paso-item">
          <strong>3. Recib√≠s lo que pediste:</strong> Al venderse el apunte, t√∫ recib√≠s tu <strong>Precio Base</strong>
          completo, antes de la retenci√≥n de IIBB.
        </li>
      </ol>
      <hr>
      <aside class="disclaimer-iibb">
        <h3 class="disclaimer-titulo">‚ö†Ô∏è Nota Importante sobre Impuestos</h3>
        <p class="disclaimer-texto">
          Tu <strong>Precio Base</strong> estar√° sujeto a la **Retenci√≥n de Ingresos Brutos (IIBB)**, un impuesto
          provincial
          obligatorio. Esta deducci√≥n la aplica directamente el procesador de pagos y var√≠a seg√∫n tu situaci√≥n fiscal.
          Te
          recomendamos consultar con tu contador.
        </p>
      </aside>

      <p class="mt-2 text-sm">
        ¬øDudas con Mercado Pago?
        <a href="{{ url_for('help_mp') }}" class="text-blue-600 hover:underline">Ver instructivo</a>.
      </p>
    </div>
    
    <div class="card mt-4" id="resumen-publicacion">
      <h3>Resumen de publicaci√≥n</h3>
      <p class="text-sm">
        Este c√°lculo es estimativo. Tomamos como base el precio que cargues arriba
        (lo que vos quer√©s recibir) y calculamos cu√°nto se suma en comisiones
        (<strong>8% Mercado Pago</strong> + <strong>12% plataforma ApuntesYa</strong>) y
        cu√°l ser√≠a el total aproximado que pagar√° la persona que compra.
      </p>

      <div class="grid">
        <div><strong>Lo que quer√©s recibir (X):</strong> $<span id="rp-precio">0.00</span></div>
        <div><strong>Comisi√≥n Mercado Pago (8%):</strong> $<span id="rp-mp">0.00</span></div>
        <div><strong>Comisi√≥n ApuntesYa (12%):</strong> $<span id="rp-ay">0.00</span></div>
        <div><strong>Neto estimado para vos:</strong> $<span id="rp-neto">0.00</span></div>
        <div><strong>Total estimado que paga el comprador:</strong> $<span id="rp-buyer">0.00</span></div>
      </div>
    </div>

    <div class="mt-3">

      <label class="inline-flex items-center">
        <input type="checkbox" name="accept_commissions" required>
        <span class="ml-2 text-sm">
          Declaro haber le√≠do y aceptado las comisiones y plazos de acreditaci√≥n indicados.
          <a href="{{ url_for('help_commissions') }}" class="text-blue-600 hover:underline">Ver detalle</a>
        </span>
      </label>
    </div>

    <script>
      (function () {
        function toNum(x) { var n = parseFloat(x); return isNaN(n) ? 0 : n; }
        var precioInput = document.querySelector('input[name="price" id="price" id="price"]');
        var box = document.getElementById('resumen-publicacion');
        if (!box) return;

        // Campo de precio: lo que quiere recibir el vendedor (X)
        var precioInput = document.getElementById('price');

        function toNum(v) {
          var x = parseFloat((v || '').replace(',', '.'));
          return isNaN(x) ? 0 : x;
        }

        var ayPct = 12.0; // plataforma
        var mpPct = 8.0;  // MP
        var totalPct = ayPct + mpPct; // 20%

        function fmt(n) {
          return n.toFixed(2);
        }

        function recalc() {
          if (!precioInput) return;
          var x = toNum(precioInput.value);  // X = lo que vos quer√©s recibir

          var feeMP = x * (mpPct / 100);
          var feeAY = x * (ayPct / 100);
          var totalBuyer = x * (1 + totalPct / 100);
          var netoVendedor = x;  // por dise√±o, X es lo que recib√≠s

          var $ = function (id) { return document.getElementById(id); };

          if ($('rp-precio')) $('rp-precio').textContent = fmt(x);
          if ($('rp-mp')) $('rp-mp').textContent = fmt(feeMP);
          if ($('rp-ay')) $('rp-ay').textContent = fmt(feeAY);
          if ($('rp-neto')) $('rp-neto').textContent = fmt(netoVendedor);
          if ($('rp-buyer')) $('rp-buyer').textContent = fmt(totalBuyer);
        }

        if (precioInput) {
          precioInput.addEventListener('input', recalc);
          recalc();
        }
      })();
    </script>

    
    <script>
      (function () {
        var box = document.getElementById('resumen-publicacion');
        if (!box) return;

        var precioInput = document.getElementById('price');

        function toNum(v) {
          var x = parseFloat((v || '').replace(',', '.'));
          return isNaN(x) ? 0 : x;
        }

        var ayPct = 12.0; // plataforma
        var mpPct = 8.0;  // MP
        var totalPct = ayPct + mpPct; // 20%

        function fmt(n) { return n.toFixed(2); }

        function recalc() {
          if (!precioInput) return;
          var x = toNum(precioInput.value);  // X = lo que vos quer√©s recibir

          var feeMP = x * (mpPct / 100);
          var feeAY = x * (ayPct / 100);
          var totalBuyer = x * (1 + totalPct / 100);
          var netoVendedor = x;  // X es lo que recib√≠s

          var $ = function (id) { return document.getElementById(id); };

          if ($('rp-precio')) $('rp-precio').textContent = fmt(x);
          if ($('rp-mp'))     $('rp-mp').textContent     = fmt(feeMP);
          if ($('rp-ay'))     $('rp-ay').textContent     = fmt(feeAY);
          if ($('rp-neto'))   $('rp-neto').textContent   = fmt(netoVendedor);
          if ($('rp-buyer'))  $('rp-buyer').textContent  = fmt(totalBuyer);
        }

        if (precioInput) {
          precioInput.addEventListener('input', recalc);
          recalc();
        }
      })();
    </script>

    <label style="margin-top:14px">Archivo PDF</label>
    <input class="input" type="file" name="file" accept="application/pdf" required>

    <button class="btn" style="margin-top:14px">Subir</button>
  </form>
</div>

<script src="{{ url_for('static', filename='js/academics_selects.js') }}?v=1"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const api = await window.initAcademicsSelects({ prefix: 'up', enableCreate: true });
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try { await api.resolveHidden(); } catch (err) { alert(err.message); return; }
      form.submit();
    });
  });
</script>
{% endblock %}